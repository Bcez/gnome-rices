var injectedAlready=document.getElementById("hippowiz-pipedrive-dynamic-injected"),HTML_CONTENT={hippo_button:"<div class='hv-embed-main-container'> <button id='hippo_video_button' data-ref='hv-embed-main-container' data-type='record_and_library' class='cui5-button cui5-button--variant-ghost hv-embed-main-icon' data-hint='Hippo Video' type='button'><img src='https://hippolms-wiz-static.s3.amazonaws.com/images/gmail_add_on/video-icon-orange.svg' class='icon_image'  height='24px' width='22px' > </button><span class='tooltiptext'>Hippo Video</span></div>"},REPORT_HTML={hippo_report_button:"<div class='hv-embed-main-container-report hv-integration-reports-button' style='display:inline;'> <button data-ref='hv-embed-main-container-report' class='hv-integration-reports' type='button'><img src='"+chrome.extension.getURL("/images/injected/hv-integration-reports.svg")+"' height='24px' width='24px'><span class='hv-report-tooltip'>Video Reports</span></button></div>",hippo_report_button_for_leads:"<div class='hv-embed-main-container-report hv-integration-reports-button' style='display:inline;'> <button data-ref='hv-embed-main-container-report' class='hv-integration-reports' type='button'><img src='"+chrome.extension.getURL("/images/injected/hv-integration-reports.svg")+"' height='20px' width='24px'><span class='hv-report-tooltip'>Video Reports</span></button></div>"};if(!injectedAlready){var hippoCsInjected='<input type=hidden id="hippowiz-pipedrive-dynamic-injected" value=true />';$(hippoCsInjected).appendTo("body"),console.log("injected pipedrive-dynamic script"),$(document).ready(function(){function e(e){var t=document.getElementById(e);if(t&&t.getAttribute("value"))return t.getAttribute("value")}function t(){return{serviceName:y.serviceName,windowId:y.windowId,tabId:y.tabId}}function o(e,t){var o=e.track_id,n=e.content.assetContent,r=n.videoShareUrl,a=n.thumbnailShareUrl,d=n.html,s=n.videoTitle;if(1==e.status)r+=r.includes("?")?"&track_id="+o:"?track_id="+o,a+=a.includes("?")?"&track_id="+o:"?track_id="+o;else{var p=n.mfInVideo,l=n.mfFormValues;if(p.length>0){for(var c="",h=0;h<p.length;h++)c=c+encodeURIComponent(p[h])+"="+encodeURIComponent(l[p[h]])+"&";""!=c&&(r+=r.includes("?")?"&"+c:"?"+c,a+=a.includes("?")?"&"+c:"?"+c)}}d=i(d,n.thumbnailShareUrl,r,a,s);var m=$(".hv-embed-main-icon[data-random-id="+t+"]");if($(".bodyEditor.body").length>0){var v=$(m).parents()[3];$(v).find($(".bodyEditor.body")).empty(),$(v).find($(".bodyEditor.body")).append(d)}else if($("div.bodyEditor[class*=wysiwyg__editor]").length>0){var f=$(m).parents()[3];$(f).find("div.bodyEditor[class*=wysiwyg__editor]").empty(),$(f).find("div.bodyEditor[class*=wysiwyg__editor]").append(d)}$("#hvPipedrivePop").remove()}function i(e,t,o,i,r){for(var a=$(e).find("a"),d=0;d<a.length;d++){var s=a[d],p=s.outerHTML.replace(/&amp;/g,"&");if(p.includes(t)){var l=n(o,i,r);e=e.includes(s.outerHTML)?e.replace(s.outerHTML,l):e.includes(p)?e.replace(p,l):e.replace(s.outerHTML,l)}}return e}function n(e,t,o){return'<div><br></div><div class="hippo-video" style="width: 100%; max-width: 360px; max-height: '+outerHeight+';" contenteditable="false" ><a href="'+e+'" style="text-decoration: none; pointer-events: none;"><div style="width: 100%; max-width: 360px; max-height: 200px; display: flex; background: #f6f6f6; border-top-left-radius: 5px; border-top-right-radius: 5px; border: 1px solid rgba(117, 117, 117, 0.1);"><span style="width: 100%; min-height: 200px; max-height: 200px;"><img src="'+t+'"  style="max-width : 360px; max-height: 200px ;text-align: center; display: table-cell; margin: auto;"><span style="width: 100%; height: 100%;"></span></span></div><div style="width: 100%; height: 50px; background: #fafafa; border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; border: 1px solid rgba(117, 117, 117, 0.1); border-top: none;"><div style="padding-left: 10px; padding-top: 3px; font-size: 16px; font-weight: bold; letter-spacing: 0.3px; font-family: Open Sans; color: #212121; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">'+o+'</div><div style="padding-left: 10px; letter-spacing: 0.3px; font-family: Open Sans; font-size: 13px; color: #52a8be;">Click to watch video</div></div></a></div><br>'}function r(){var e=0,t=setInterval(function(){$(".leCyOW").length>0&&(clearInterval(t),d("leads")),++e>200&&clearInterval(t)},25)}function a(){$(".hv-embed-main-container").remove(),$(".editorButtons").length>0?$(".editorButtons").append($(HTML_CONTENT.hippo_button)):$("div.editorToolbar[class*=toolbar__toolbar]").length>0&&$(".footer__left").prepend($(HTML_CONTENT.hippo_button)),s(),$(".hv-embed-main-icon").off("click"),$(".hv-embed-main-icon").on("click",h)}function d(e){if($(".hv-embed-main-container-report").remove(),"leads"==e)$(".leCyOW").append($(REPORT_HTML.hippo_report_button_for_leads));else{var t=b();if(t){var o=$(t).find(".infoBlock"),i=$(o).find(".actions-outer"),n=$(i).find(".actions");$(n).addClass("hv-fr"),$(i).append($(REPORT_HTML.hippo_report_button))}}$(".hv-integration-reports").off("click").on("click",v)}function s(){var e=$("div.bodyEditor[class*=wysiwyg__editor]");$(".bodyEditor.body").length>0?e=$(".bodyEditor.body"):$("div.bodyEditor[class*=wysiwyg__editor]").length>0&&(e=$("div.bodyEditor[class*=wysiwyg__editor]")),$(e).off("mouseup").on("mouseup",p),$(e).off("keyup").on("keyup",p)}function p(e){var t=window.getSelection(),o=t.anchorNode;$(e.currentTarget).parent().find(".hv-current-cursor").removeClass("hv-current-cursor").removeAttr("anchor-offset");var i;1==o.nodeType?i=$(o):3==o.nodeType&&(i=$(o.parentElement)),$(i).addClass("hv-current-cursor").attr("anchor-offset",t.anchorOffset)}function l(e){var o=g(),i=o.email,n=o.firstName,r=window.location.href,a=t(),d=u();a.messageFromContentScript1234=!0,a.initWorkflowPop=!0,a.msgType="workflow",a.payload={logPrefix:y.logPrefix,popType:"sales",popId:"hvPipedrivePop",assetContent:{uniqueId:e,mfFormValues:{"First Name":n,Email:i,Referer:r}},popConfig:{showEditOption:!0,showTemplatesOption:!1,showContactsOption:!1,showVideoPageLibrary:!0,addSalesUtmParams:!1,popReinitConditions:[],showMfForm:!0,defaultHtmlContent:d.html,fetchMfInVideo:!0,mandatoryEmailMf:!0,showCustomizeComponent:!0,showTelePrompter:!0,showLandingPageComponent:!0}},y.port.postMessage(a)}function c(e){var o=e.workflowConfig,i=t();i.messageFromContentScript1234=!0,i.messageType="pipedrive_dynamic",i.getUTMToken=!0,i.popId=o.popId,i.content=o,i.serviceName=y.serviceName,y.port.postMessage(i)}function h(e){$("#hvPipedrivePop").remove();var t=f(20);$(e.currentTarget).attr("data-random-id",t),l(t)}function m(){var e=g(),o=e.email,i=e.firstName,n=t();n.messageFromContentScript1234=!0,n.initReportPop=!0,n.randomId="",n.msgType="workflow",n.reportBtn="hv-integration-reports",n.contactEmail=o,n.contactName=i,n.payload={popId:"hvOutreachReportPop",logPrefix:y.logPrefix},y.port.postMessage(n)}function v(e){$("#hvOutreachReportPop").remove(),$(".hv-integration-reports").attr("disabled",!0),m()}function f(e){for(var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=o.length,n=0;n<e;n++)t+=o.charAt(Math.floor(Math.random()*i));return t}function u(){var e=0==$("div.bodyEditor[class*=wysiwyg__editor]").length?$(".richTextArea .bodyEditorWrapper  .bodyEditor"):$("div.bodyEditor[class*=wysiwyg__editor]"),t=$(e).length>1?$(e)[1].innerHTML:$(e)[0].innerHTML;return t=t.replace(new RegExp("<div>","g"),"<p>"),t=t.replace(new RegExp("<div ","g"),"<p "),t=t.replace(new RegExp("</div>","g"),"</p>"),{html:t}}function g(){var e="",t="";if(window.location.href.includes("/leads")){var o=$('[data-testid = "PersonSection"]');o&&(e=$(o).find('[class*="__Email__readValue__K1D"]').find('a[href*="mailto:"]').text(),t=$(o).find('[data-testid="LinkedFieldTitleText"]').text())}else{var i=b();i&&(e=$(i).find('[data-field-key="email"]').find('[data-test="email-label"]').text(),t=$(i).find(".infoBlock").find("h1").text())}return{email:e,firstName:t}}function b(){for(var e=$(".viewContainer"),t=0;t<e.length;t++){if("block"==$($(e)[t]).css("display"))return e[t]}}var y=function(){var t={};return t.serviceName=e("hvIntegName"),t.windowId=Number(e("hvWindowId")),t.tabId=Number(e("hvTabId")),t.logPrefix=" PIPEDRIVE_DYNAMIC :: ",t.port=chrome.extension.connect({name:t.serviceName+"::"+t.windowId+"::"+t.tabId}),t}();!function(){var e=t();e.messageFromContentScript1234=!0,e.injectHvWorkflowScripts=!0,y.port.postMessage(e)}(),y.port.onMessage.addListener(function(e,t,i){if(msgFromPort=e.backgroundRecordingMessage,"insertFromWorkflowPop"==msgFromPort&&e.data.serviceName==y.serviceName&&e.data.tabId==y.tabId&&c(e.data),"insertVideoInPipedriveMailBox"==msgFromPort&&e.data.tabId==y.tabId){var n=e.data.content.assetContent.uniqueId;o(e.data,n)}}),MutationObserver=window.MutationObserver||window.WebKitMutationObserver,new MutationObserver(function(e,t){for(var o in e){var i=e[o];if($(i.target).hasClass("viewContainer")&&window.location.href.includes("/person/")&&d(),$(i.target).hasClass("infoBlock")&&window.location.href.includes("/person/")&&d(),$(i.target).attr("class").startsWith("AnimationWrapper__Wrapper")&&window.location.href.includes("/leads")&&r(),$(i.target).hasClass("newThreadComposer")||$(i.target).hasClass("mailComposeView")||$(i.target).hasClass("replyForwardComposer")){var n=$(i.target).find(".composer__recipients").children();$.each(n,function(e,t){if($(t).hasClass("composer__contentEditable")){var o=$(t).find("div.editorToolbar[class*=toolbar__toolbar]").find(".hv-embed-main-container");0==$(o).length&&a()}else if($(t).hasClass("richTextArea")){var o=$(t).find(".editorButtons").find(".hv-embed-main-container");0==$(o).length&&a()}})}if($(i.target).hasClass("bodyEditorWrapper")){var s=$(".editorButtons").find(".hv-embed-main-container");0==$(s).length&&a()}}}).observe(document,{subtree:!0,childlist:!0,attributes:!0})})}