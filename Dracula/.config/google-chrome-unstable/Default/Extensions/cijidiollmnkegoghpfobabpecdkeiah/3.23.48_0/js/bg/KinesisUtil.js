const isLocal="cijidiollmnkegoghpfobabpecdkeiah"!==chrome.runtime.id,ENDPOINT=isLocal?"http://localhost:3000":"https://www.hippovideo.io";var cognitoConfig={},currentStreamName,currentStreamType,AWSKinesis,AWSCredentials,AWSRegion,beanstalkName;const kinesisStorageKey="hv-kinesis-token",STREAM_TYPE=2,OPERATION_TYPE=2,KinesisUtil={_updateConfig:function(){var e=this;return this._getToken(function(){try{AWSCredentials=new AWS.CognitoIdentityCredentials({IdentityId:cognitoConfig.identity_id,Logins:{"cognito-identity.amazonaws.com":cognitoConfig.token}},{region:cognitoConfig.region?cognitoConfig.region:"us-east-1",httpOptions:{timeout:1e4}}),AWSRegion=cognitoConfig.region?cognitoConfig.region:"us-east-1",beanstalkName=cognitoConfig.bean_stalk_environment}catch(e){console.log(e)}currentStreamName=cognitoConfig.stream_name,e._initKinesis()})},_initKinesis:function(){try{AWSKinesis=new AWS.Kinesis({credentials:AWSCredentials,region:AWSRegion,httpOptions:{timeout:1e4}})}catch(e){console.log(e)}},pushRecord:function(e,t){var n=this;currentStreamType=2;var i={};i.stream_type=currentStreamType,i.action_name=e,i.assetId=n.isBlank(t)?"":t,i.type=2,this._updateConfig().then(function(){chrome.storage.sync.get(["wizAuthToken","wizUserId"],function(e){if(n.isBlank(e.wizAuthToken)||n.isBlank(e.wizUserId))return void console.warn("invalid user details, unable to push record");i.authentication_token=e.wizAuthToken,i.userId=e.wizUserId,beanstalkName&&(i.bean_stalk_environment=beanstalkName);var t={Data:JSON.stringify(i),PartitionKey:i.userId.toString(),StreamName:currentStreamName};AWSKinesis.putRecord(t,function(e,t){e&&(console.log(e),n._kinesisFallback(i))})})})},_getToken:function(e){var t=this;return new Promise(function(n,i){cognitoConfig=function(n){function i(){t._makeRefreshTokenRequest(function(e){delete e.status,cognitoConfig=e,r(e),o()})}function o(){e&&e(),n&&n()}function a(e){return(new Date).getTime()>=new Date(e).getTime()}function r(e){try{chrome.storage.local.get([kinesisStorageKey],function(t){var n={};n[currentStreamType]=JSON.stringify({value:e,expiry:new Date((new Date).getTime()+105e5)});var i=t||{};i[kinesisStorageKey]=Object.assign(i[kinesisStorageKey]||{},n),chrome.storage.local.set(i)})}catch(e){console.log(e)}}chrome.storage.local.get([kinesisStorageKey],function(e){if(e[kinesisStorageKey]&&e[kinesisStorageKey][currentStreamType]){var t=JSON.parse(e[kinesisStorageKey][currentStreamType]);a(t.expiry)?(chrome.storage.local.remove(e[kinesisStorageKey][currentStreamType]),i()):(cognitoConfig=t.value,o())}else i()})}(n)})},_kinesisFallback:function(e){var t=this;chrome.storage.sync.get(["wizUserEmail"],function(n){if(t.isBlank(n.wizUserEmail))return void console.warn("invalid user details, unable to push record");e.email=encodeURIComponent(n.wizUserEmail),t._makeFallBackRequest(e)})},_makeRefreshTokenRequest:function(e,t){var n=ENDPOINT+"/api/internal/extension/identity";$.ajax({url:n,method:"GET",success:function(t){e&&e(t)},error:function(e){console.error("Identity request for track activity failed:",e.statusText),t&&t(e)}})},_makeFallBackRequest:function(e,t,n){var i=ENDPOINT+"/user/track_dynamic_integ_action";$.ajax({url:i,method:"POST",data:e,success:function(e){t&&t(e)},error:function(e){console.error("track activity fallback failed:",e.statusText),n&&n(e)}})},isBlank:function(e){return!e||"string"==typeof e&&e.trim().length<=0}};