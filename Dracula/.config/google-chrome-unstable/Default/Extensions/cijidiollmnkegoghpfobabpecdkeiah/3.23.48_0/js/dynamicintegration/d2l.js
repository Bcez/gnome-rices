var injectedAlready=document.getElementById("hippowiz-d2l-injected"),currentWidgetId,widgetRefCount=0,isRecording,recordRefType,pageTitle,waitingForUrl=!1,foundIframeUrl=!1,shareUrl,startRecordContext;if(!injectedAlready){var hippoCsInjected='<input type=hidden id="hippowiz-d2l-injected" value=true />';$(hippoCsInjected).appendTo("body");var port;console.log("injected d2l script"),$(document).ready(function(){function e(e){if(0==e.find('.d2l-htmleditor-button[aria-label="Record Video"]').length){widgetRefCount+=1;var t='<div class="d2l-htmleditor-group d2l-htmleditor-hide1"><span class="d2l-htmleditor-toolbar-item">\t        \t\t\t\t\t\t<a class="d2l-htmleditor-button" id="hv-embed-create-icon-'+widgetRefCount+'" title="Record Video" role="button" aria-label="Record Video" tabindex="0">\t        \t\t\t\t\t\t<img style="position: relative;top: 0px;margin-right: 1px;" class="hv-embed-dom-click" src="'+chrome.runtime.getURL("/images/injected/hippo-grey-logo.png")+'">\t        \t\t\t\t\t\t<span style="position: relative;bottom: 5px;font-size: 14px;">Create Video</span></a>\t        \t\t\t\t\t\t</div>';e.find('.d2l-htmleditor-button[aria-label="Insert Image"]').parent().parent().before($(t)),$("#hv-embed-create-icon-"+widgetRefCount).off("click"),$("#hv-embed-create-icon-"+widgetRefCount).on("click",a)}}function t(e){widgetRefCount+=1;var t=e.attr("title").split("New content for ")[1];elemStr='<span class="hv-embed-button-container"><button class="d2l-button hv-embed-create-video" data-context="'+t+'" id="hv-embed-create-btn-'+widgetRefCount+'" title="Create Video">\t\t\t\t\t\t\t<img style="position: relative;top: 5px;right: 10px;" class="hv-embed-dom-click" src="'+chrome.runtime.getURL("/images/injected/hippo-grey-logo.png")+'">\t\t\t\t\t\t\t<span style="position:relative;margin-right:-20px;right:5px;">Create Video</span></button></span>',e.after($(elemStr)),e.parent().parent().addClass("hv-embed-create-btn-add"),$("#hv-embed-create-btn-"+widgetRefCount).off("click"),$("#hv-embed-create-btn-"+widgetRefCount).on("click",a)}function i(e){if(waitingForUrl){var t=decodeURIComponent(location.href),i=u("titleRef",t),a=u("recordType",t),c=u("recordContext",t);pageTitle=$(".d2l-page-title.d2l-heading").html(),"icon"==a||"assignmentcreatebtn"==a?shareUrl=e.shareLink:"btn"==a&&(shareUrl=e.embedUrl),void 0!=i&&"Syllabus"==i&&i==pageTitle?"icon"==a&&n():"icon"==a&&void 0!=pageTitle?$('.d2l-textblock:contains("'+pageTitle+'")').length>0&&(g($('.d2l-textblock:contains("'+pageTitle+'")')[0],"click"),setTimeout(function(){n()},2e3)):"icon"==a?(waitingForUrl=!0,o()):"assignmentcreatebtn"==a?d():waitingForUrl&&void 0!=c&&r(c)}}function n(){$('.d2l-editable[title="Edit description for '+pageTitle+'"]').length>0&&(g($('.d2l-editable[title="Edit description for '+pageTitle+'"]')[0],"click"),setTimeout(function(){o()},1e3))}function o(){waitingForUrl=!0,$('.d2l-htmleditor-button[title="Insert Quicklink"]').length>0&&g($('.d2l-htmleditor-button[title="Insert Quicklink"]')[0],"click")}function r(e){g($('.d2l-button-menu.bsi-button-menu.bsi-button-menu-primary[title="New content for '+e+'"]')[0],"click"),setTimeout(function(){g($('.d2l-button-menu.bsi-button-menu.bsi-button-menu-primary[title="New content for '+e+'"]').parent().find('.d2l-contextmenu-item .vui-dropdown-menu-item-link span:contains("Video or Audio")')[0],"click"),setTimeout(function(){if($(".d2l-dialog-frame").contents().find("#WebEmbedSource").length>0){var e="<iframe width='720' height='405' scrolling='no' frameborder=0 marginwidth=0 marginheight=0 src='"+shareUrl+"' allowfullscreen></iframe>";$(".d2l-dialog-frame").contents().find("#WebEmbedSource").val(e),g($(".d2l-dialog-frame").contents().find("#WebEmbedSource")[0],"keydown"),setTimeout(function(){g($(".d2l-dialog-frame").contents().find("#WebEmbedSource")[0],"keyup")},200),shareUrl=void 0,waitingForUrl=!1}},1500)},500)}function d(){$("#z_cb").length>0&&(g($("#z_cb")[0],"click"),setTimeout(function(){$('.dcm_a.vui-dropdown-menu-item-link span:contains("Link")').parent().length>0&&(g($('.dcm_a.vui-dropdown-menu-item-link span:contains("Link")').parent()[0],"click"),setTimeout(function(){$(".d2l-dialog-frame").contents().find('.d2l-edit.vui-input[name="href"]').length>0&&($(".d2l-dialog-frame").contents().find('.d2l-edit.vui-input[name="href"]').val(shareUrl),shareUrl=void 0,waitingForUrl=void 0)},1500))},500))}function a(e){isRecording||(startRecordContext=$(e.currentTarget).attr("data-context"),$(".hv-embed-widget").is(":visible")&&$("#"+e.currentTarget.id).parent().has(".hv-embed-widget").length>0?$(".hv-widget-container").remove():($(".hv-widget-container").remove(),l(e.currentTarget.id)))}function c(e){currentWidgetId=e,$("."+e).empty().load(chrome.extension.getURL("html/injected/recordandlibrarywidget.html"),function(){var t='<img class="hv-embed-dom-click hv-embed-widget-top-left-arrow" src="'+chrome.runtime.getURL("/images/injected/widget-top-arrow.png")+'">';$(t).appendTo($("."+e)),$(".hv-embed-record-button").off("click"),$(".hv-embed-record-button").on("click",s),$(".hv-embed-widget").show(),$(".hv-embed-widget-top-left-arrow").show(),checkAndShowWidget()})}function l(e){if(0==$("#"+e).parent().has(".hv-widget-container").length){var t=e.split("-");recordRefType=t[t.length-2];var i;if(void 0==recordRefType||""==recordRefType)return;"icon"==recordRefType?i='<div class="hv-widget-container hv-container-for-icon"></div>':"btn"!=recordRefType&&"assignmentcreatebtn"!=recordRefType||(i='<div class="hv-widget-container hv-container-for-button"></div>'),$(i).appendTo($("#"+e).parent())}c("hv-widget-container")}function s(){pageTitle=$(".d2l-page-title.d2l-heading").html();var e=m(location.href,"titleRef",pageTitle);e=m(e,"recordType",recordRefType),e="Syllabus"==pageTitle?m(e,"itemIdentifier","Overview"):"Table of Contents"==pageTitle?m(e,"itemIdentifier","TOC"):m(e,"itemIdentifier",""),void 0!=startRecordContext&&(e=m(e,"recordContext",startRecordContext),startRecordContext=void 0),recordConfiguration.fromPopup=!0,recordConfiguration.initiator="d2l",recordConfiguration.tabRecording=!1,recordConfiguration.separateLayer=!1,recordConfiguration.systemAudio=!0,port.postMessage({doBackgroundRecording:!0,config:recordConfiguration,currentUrl:e,messageFromContentScript1234:!0}),$(".hv-widget-container").remove(),isRecording=!0}function g(e,t){if(e.fireEvent)e.fireEvent("on"+t);else{var i=document.createEvent("Events");i.initEvent(t,!0,!1),e.dispatchEvent(i)}}function m(e,t,i){var n=new RegExp("([?&])"+t+"=.*?(&|$)","i");return separator=-1!==e.indexOf("?")?"&":"?",e.match(n)?e.replace(n,"$1"+t+"="+i+"$2"):e+separator+t+"="+i}function u(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var i=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)"),n=i.exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null}port=chrome.extension.connect({name:"d2lscript"}),port.postMessage({askToInsertRecordAndLibScript:!0,messageFromContentScript1234:!0}),$(document).on("click",function(e){$(e.target).hasClass("hv-embed-dom-click")||$(e.target).hasClass("hv-embed-create-video")||$(".hv-embed-widget").is(":visible")&&$(".hv-widget-container").remove()});var p=decodeURIComponent(location.href);u("titleRef",p);void 0!=u("recordType",p)&&(waitingForUrl=!0,port.postMessage({getShareUrl:!0,initiator:"d2l",messageFromContentScript1234:!0}));var h=location.pathname.split("/");if("folder_newedit_properties.d2l"==h[h.length-1]){widgetRefCount+=1;var f='<span style="position: relative;display: inline-block;"><button class="d2l-button hv-embed-create-video" data-context="new-assignment-folder"\t\t\t\t\t\t\t\t id="hv-embed-create-assignmentcreatebtn-'+widgetRefCount+'">\t\t\t\t\t\t\t\t <img style="position: relative;top: 0px;right: 10px;" class="hv-embed-dom-click" src="'+chrome.runtime.getURL("/images/injected/hippo-grey-logo.png")+'">\t\t\t\t\t\t\t\t <span style="position:relative;margin-right:-20px;right:5px;">Create Video</span></button></span>';$("#z_cd").after($(f)),$("#hv-embed-create-assignmentcreatebtn-"+widgetRefCount).off("click"),$("#hv-embed-create-assignmentcreatebtn-"+widgetRefCount).on("click",a)}$(".d2l-button-menu.bsi-button-menu.bsi-button-menu-primary").each(function(){$(this).length>0&&t($(this))}),$(".d2l-htmleditor.d2l-htmleditor-wysiwyg").length>0&&0==$(".d2l-htmleditor.d2l-htmleditor-wysiwyg").find('.d2l-htmleditor-button[aria-label="Record Video"]').length&&e($(".d2l-htmleditor.d2l-htmleditor-wysiwyg")),MutationObserver=window.MutationObserver||window.WebKitMutationObserver,new MutationObserver(function(i,n){for(var o in i){var r=i[o];$(r.target).hasClass("d2l-button-menu bsi-button-menu bsi-button-menu-primary")&&($(r.target).parent().parent().hasClass("hv-embed-create-btn-add")||t($(r.target))),$(r.target).hasClass("d2l-htmleditor d2l-htmleditor-wysiwyg")&&e($(r.target)),$(r.target).hasClass("d2l-dialog")&&!foundIframeUrl&&waitingForUrl&&(g($(".d2l-dialog-frame").contents().find('.d2l-datalist-item-content[title="Url"]')[0],"click"),setTimeout(function(){$(".d2l-dialog-frame").contents().find('.d2l-edit.vui-input[name="href"]').val(shareUrl),waitingForUrl=!1,shareUrl=void 0},1e3),foundIframeUrl=!0)}}).observe(document,{subtree:!0,attributes:!0}),port.onMessage.addListener(function(e,t,n){if("currentstate"==e.backgroundRecordingMessage&&(isRecording=!(!e.data.isRecording&&!e.data.isPaused)),"recording_cancelled"==e.backgroundRecordingMessage&&(isRecording=!1),"stopped_recording"==e.backgroundRecordingMessage&&(isRecording=!1),"bothstarted-d2l"==e.backgroundRecordingMessage&&(isRecording=!0,port.postMessage({startCountDownGeneral:!0,messageFromContentScript1234:!0}),$(".hv-widget-container").remove()),"d2l-share-link"==e.backgroundRecordingMessage&&void 0!=e.data.shareLink&&i(e.data),"bothstarted"==e.backgroundRecordingMessage.split()[0]&&(isRecording=!0),"videoCopyLink"==e.backgroundRecordingMessage){var a=e.data;"d2l"==a.integType&&(shareUrl=a.url,$(".hv-widget-container").remove(),"icon"==recordRefType?o():"assignmentcreatebtn"==recordRefType?(waitingForUrl=!0,d()):"btn"==recordRefType&&(waitingForUrl=!0,r(startRecordContext)))}})})}