function attachVideoInGmail(e,o){"compose"!=o||e.url||(e.url="https://mail.google.com");var n=-1,t="reply"==o?"https://mail.google.com/mail/u/0/#inbox":"https://mail.google.com";chrome.windows.getAll({populate:!0},function(r){if(!e.openInNewTab)for(var i=0;i<r.length;i++)for(var a=r[i],s=0;s<a.tabs.length;s++){var c=a.tabs[s];if(c.url.includes(t)){n=c.id;break}}-1==n?(videoToBeAttached={shareUrl:e.shareUrl,thumbnailUrl:e.thumbnailUrl,embedUrl:e.embedLink,composeType:o,videoTitle:e.videoTitle,assetId:e.assetId,customerHost:e.customerHost},chrome.tabs.create({url:e.url})):(chrome.tabs.update(n,{selected:!0,highlighted:!0}),videoToBeAttached={shareUrl:e.shareUrl,thumbnailUrl:e.thumbnailUrl,embedUrl:e.embedLink,composeType:o,videoTitle:e.videoTitle,assetId:e.assetId,customerHost:e.customerHost},"reply"==o?(messageContentScripts("openGmailReplyBox",{isVideoToBeAttached:!0,videoToBeAttached:videoToBeAttached,payload:{tabId:n}}),videoToBeAttached=void 0):"compose"==o&&(messageContentScripts("openGmailComposeBox",{isVideoToBeAttached:!0,videoToBeAttached:videoToBeAttached,payload:{tabId:n}}),videoToBeAttached=void 0))})}function signInUserAutomatically(e){$.ajax({url:server+"/video/delivery/user_info",method:"GET",success:function(o){"nil"!=o.user_email&&(authToken=o.auth_token,userEmail=o.user_email,console.info("signInUserAutomatically - Signed in :: "+e+" Extension",{authToken:authToken,userEmail:userEmail}),chrome.storage.sync.set({wizUserEmail:userEmail,wizAuthToken:authToken},function(){}),LoggingUtils.userEmailId=userEmail,LoggingUtils.userId=o.user_id,APIClient.isUserSignedIn(function(e){parseAuthResponse(e)}))}})}function clearAuthenticationData(){chrome.storage.sync.remove(["wizUserEmail","wizAuthToken","wizDigest"]);try{googleSignout()}catch(e){}}function updateAspectRatio(e,o){o&&o.screenRecord&&o.webCam&&"circle"==e.webcamShape||(videoAspectRatio=void 0,void 0!=e&&0!=e&&void 0!=e.aspectRatio&&(videoAspectRatio=e.aspectRatio,"Default"==e.aspectRatio&&(videoAspectRatio=void 0)))}function getAspectRatio(){return recordingConfiguration&&recordingConfiguration.screenRecord&&(recordingConfiguration.webCam||recordingConfiguration.pseudoWebcam)&&"circle"==recordingConfiguration.webcamShape?1.33333333:videoAspectRatio}function setDefaults(){chrome.browserAction.setIcon({path:"/images/extension/main-icon.png"}),screenStream&&(screenStream.stop(),screenStream&&screenStream.onended&&screenStream.onended()),chrome.browserAction.setTitle({title:"Hippo Video"}),screenStream=null,isRecording=!1,messageRecordingStateToContentScripts(),isRecordingInitiated=!1}function setBadgeText(e,o){void 0===o?chrome.browserAction.setBadgeBackgroundColor({color:[255,0,0,255]}):chrome.browserAction.setBadgeBackgroundColor({color:o}),chrome.browserAction.setBadgeText({text:e+""})}function checkTime(){if(initialTime){var e=Date.now()-initialTime,o=convertTime(e);setBadgeText(o),chrome.browserAction.setTitle({title:"Recording duration: "+o})}}function convertTime(e){var o=Math.floor(e/1e3),n=Math.floor(o/60),t=o-60*n;return n+="",t+="",n.length,1===t.length&&(t="0"+t),n+":"+t}function getChromeVersion(){var e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);return e?parseInt(e[2],10):52}function finishBackgroundRecording(){stopBackgroundRecording(),is_guest_user||askAccountConfirmation||showNotification("Video recorded successfully and URL copied to clipboard!")}function togglePauseResume(){if(isRecording){if(isPaused){resumeBackgroundRecording(),highlightsEvents.pause_play="hvPlay",highlightsEvents.current_action="hvPlay";var e={current_action:highlightsEvents.current_action,pause_play:highlightsEvents.pause_play};return messageContentScripts("highlightState",e),"resumed"}pauseBackgroundRecording(),highlightsEvents.pause_play="hvPause",highlightsEvents.current_action="hvPause";var e={current_action:highlightsEvents.current_action,pause_play:highlightsEvents.pause_play};return messageContentScripts("highlightState",e),"paused"}}function parseAuthResponse(e){e.status&&(updateLocalStorageDynamicIntegConfig(e.dynamicIntegConfig,e.dynamicIntegUrls),chrome.storage.sync.set({orgToken:e.user_info.org_tok,wizUserId:e.user_info.user_id}),updateGmailIconPosition(e.placeIconInGmailToolbox),e.genericIntegWidgets&&(genericIntegWidgets=e.genericIntegWidgets))}function updateGmailIconPosition(e){chrome.storage.sync.set({placeIconInGmailToolbox:e})}function updateLocalStorageDynamicIntegConfig(e,o){if(e){var n=JSON.parse(JSON.stringify(e));chrome.storage.sync.set({dynamicIntegConfigurations:n}),chrome.storage.sync.remove(["one_to_one_preview_shown","sequence_preview_shown"],function(){}),console.silent("dynamic integ config updated",{integConfig:e})}if(o){var t=JSON.parse(JSON.stringify(o));chrome.storage.sync.set({dynamicIntegUrls:t}),console.silent("dynamic integ urls updated",{integUrls:t})}}function checkAndInjectDynamicIntegScripts(e,o,n,t){chrome.storage.sync.get(["dynamicIntegUrls"],function(r){if(r&&r.dynamicIntegUrls){var i="string"==typeof r.dynamicIntegUrls?JSON.parse(r.dynamicIntegUrls):r.dynamicIntegUrls,a=getDynamicIntegType(i,e,o);a&&injectDynamicIntegScripts(a,n,t)}else{var a=getDynamicIntegType(fallbackDynamicIntegUrls,e,o);a&&injectDynamicIntegScripts(a,n,t)}})}function injectDynamicIntegScripts(e,o,n){chrome.storage.sync.get(["dynamicIntegConfigurations"],function(t){t&&t.dynamicIntegConfigurations?t.dynamicIntegConfigurations[e]&&(insertDynamicIntegScripts(o,e,n),console.info(e+" dynamic integration enabled")):(insertDynamicIntegScripts(o,e,n),console.info(e+" injected - no local storage value"))})}function getDynamicIntegType(e,o,n){if(e)for(var t in e){var r=e[t];if(r.host||r.href){var i=!1,a=!1;if(r.host)for(var s=0;s<r.host.length;++s){var c=r.host[s];i=i||o.includes(c)}else i=!0;if(r.href)for(var d=0;d<r.href.length;++d){var g=r.href[d];a=a||n.includes(g)}else a=!0;if(i&&a)return t}}}function checkAndSendStopRecordingMsg(e){chrome.storage.sync.get(["dynamicIntegConfigurations"],function(o){o&&o.dynamicIntegConfigurations&&o.dynamicIntegConfigurations.hasOwnProperty(e.initiator)&&(previewIframeData={initiator:e.initiator,recordConfiguration:e}),messageContentScripts("stopped_recording",previewIframeData),previewIframeData=void 0})}function injectCsAndAssWhileRecording(e,o){(isRecording||-1!==o.indexOf("localhost")||-1!==o.indexOf("www.hippovideo.io"))&&(console.silent("injecting content script"),insertContentScripts(e)),insertAllSitesScript(e)}function injectHvWorkflowScripts(e,o){injectScriptAndCss(e,void 0,o,["js/common/jquery-ui.min.js","js/common/content-script.js","js/common/jquery.caret.min.js","js/common/jquery.atwho.min.js","js/common/quill.min.js","js/common/dompurify.min.js","js/dynamicintegration/hv_workflow/workflow_pop.js","js/dynamicintegration/hv_workflow/workflow_utilities.js","js/dynamicintegration/hv_workflow/workflow_create_video.js","js/dynamicintegration/hv_workflow/workflow_templates.js","js/dynamicintegration/hv_workflow/workflow_contacts.js","js/dynamicintegration/hv_workflow/workflow_reports.js","js/dynamicintegration/hv_workflow/workflow_integ_onboarding.js","js/dynamicintegration/hv_workflow/workflow_teleprompter.js"],["css/content-css.css","css/recordwidget.css","css/jquery-ui.min.css","css/jquery.atwho.css","css/quill.snow.css","css/hv_workflow.css","css/hv_reports.css","css/hv_integ_onboarding.css"])}function handleWorkflowBackgroundMessages(e){if(e.fetchShortenUrl&&getParameterFromChromeLocalStorage(chromeLocalStorageConstants.isShortenUrlEnabled,function(o){o?APIClient.requestServer("fetchShortenUrl",{url:e.urlToBeShortened},function(o){e.shortenUrl=o.shorten_url?o.shorten_url:e.urlToBeShortened,messageContentScripts("fetchShortenUrlResponse",e)},function(o){e.shortenUrl=e.urlToBeShortened,messageContentScripts("fetchShortenUrlResponse",e)}):(e.shortenUrl=e.urlToBeShortened,messageContentScripts("fetchShortenUrlResponse",e))}),e.initTeleprompter&&messageContentScripts("initTeleprompter",e),e.fetchTeleprompterData&&APIClient.fetchTeleprompterData(function(o){e.status=!0,e.response=o,messageContentScripts("fetchTeleprompterData",e)},function(o){e.status=!1,e.response=o,messageContentScripts("fetchTeleprompterData",e)}),e.initWorkflowPop&&messageContentScripts("initWorkflowPop",e),e.openWorkflowPop&&messageContentScripts("openWorkflowPop",e),e.createAccessPop&&messageContentScripts("createAccessPop",e),e.createSigninPop&&messageContentScripts("createSigninPop",e),e.checkAuth&&APIClient.isUserSignedIn(function(o){parseAuthResponse(o),e.response=o,e.status=!0,messageContentScripts("authcheckResponse",e)},function(o){e.status=!1,messageContentScripts("authcheckResponse",e)}),e.cancelFromWorkflowPop&&messageContentScripts("cancelFromWorkflowPop",e),e.insertFromWorkflowPop&&(APIClient.trackHighlightsActions("action",e.workflowConfig.logPrefix+" Video Inserted"),messageContentScripts("insertFromWorkflowPop",e)),e.trackWorkflowActivity&&APIClient.trackDynamicIntegAction(e.actionName),e.handleTopMenuClick&&messageContentScripts("handleTopMenuClick",e),e.popScreenSwitch&&messageContentScripts("popScreenSwitch",e),e.fetchVideos){e.fetchType,APIClient.fetchVideos(e.fetchType,e.offset,e.categoryId,e.fetchCategories,e.libraryType,!0,function(o){e.status=!0,e.response=o,messageEmbedScripts("fetchVideosResponse",e)},function(e){})}if(e.fetchPages&&APIClient.requestServer("fetchPages",e.paramData,function(o){e.status=!0,e.response=o,messageContentScripts("fetchPagesResponse",e)},function(o){e.status=!1,messageContentScripts("fetchPagesResponse",e)}),e.fetchSearchVideos&&APIClient.fetchSearchVideos(e.searchToken,e.offset,e.categoryId,e.libraryType,function(o){e.status=!0,e.response=o,messageContentScripts("fetchSearchVideosResponse",e)},function(o){e.status=!1,e.response=o,messageContentScripts("fetchSearchVideosResponse",e)}),e.flashAlertInWorkflowPop&&messageContentScripts("flashAlertInWorkflowPop",e),e.fetchVideoCategories&&APIClient.fetchVideoCategories(function(o){e.status=!0,e.response=o,messageContentScripts("fetchVideoCategoriesResponse",e)},function(o){e.status=!1,messageContentScripts("fetchVideoCategoriesResponse",e)}),e.fetchVideoDetails&&APIClient.fechVideoDetails(e.workflowConfig.assetContent.assetId,function(o){e.status=!0,e.response=o,messageEmbedScripts("videoDetailsResponse",e)},function(o){e.status=!1,messageEmbedScripts("videoDetailsResponse",e)}),e.markRecordingStatus&&messageContentScripts("markRecordingStatus",e),e.fetchGdriveAccounts&&APIClient.requestServer("getGDriveAccounts",void 0,function(o){e.status=!0,e.response=o,messageContentScripts("fetchGdriveAccountsResponse",e)},function(o){e.status=!1,messageContentScripts("fetchGdriveAccountsResponse",e)}),e.listDriveFiles&&APIClient.requestServer("listDriveFiles",e.params,function(o){e.status=!0,e.response=o,messageContentScripts("listDriveFilesResponse",e)},function(o){e.status=!1,messageContentScripts("listDriveFilesResponse",e)}),e.configureGDriveAccount){var o={drive_import:!0,auth_code:e.authcode};APIClient.requestServer("configureGDriveApp",o,function(o){e.status=!0,e.response=o,messageContentScripts("configureGDriveAccountResponse",e)},function(o){e.status=!1,messageContentScripts("configureGDriveAccountResponse",e)})}if(e.fetchMergeFields&&APIClient.requestServer("getMergeFields",e.params,function(o){e.status=!0,e.response=o,messageContentScripts("fetchMergeFieldsResponse",e)},function(o){e.status=!1,messageContentScripts("fetchMergeFieldsResponse",e)}),e.fetchEmailTemplates&&APIClient.requestServer("fetchEmailTemplates",void 0,function(o){e.status=!0,e.response=o,messageContentScripts("fetchEmailTemplatesResponse",e)},function(o){e.status=!1,messageContentScripts("fetchEmailTemplatesResponse",e)}),e.configureGContactAccount){var n={drive_import:!0,auth_code:e.authcode};APIClient.requestServer("configureGContact",n,function(o){e.status=!0,e.response=o,messageContentScripts("configureGContactAccountResponse",e)},function(o){e.status=!1,messageContentScripts("configureGContactAccountResponse",e)})}if(e.fetchGContactAccounts&&APIClient.requestServer("fetchGContactAccounts",{provider:"gcontacts"},function(o){e.status=!0,e.response=o,messageContentScripts("fetchGContactAccountResponse",e)},function(o){e.status=!1,messageContentScripts("fetchGContactAccountResponse",e)}),e.listGoogleContacts&&APIClient.requestServer("fetchGoogleContacts",e.params,function(o){e.status=!0,e.response=o,messageContentScripts("fetchGoogleContactsResponse",e)},function(o){e.status=!1,messageContentScripts("fetchGoogleContactsResponse",e)}),e.parseGoogleSheet&&APIClient.requestServer("parseGoogleSheet",e.params,function(o){e.status=!0,e.response=o,messageContentScripts("parseGoogleSheetResponse",e)},function(o){e.status=!1,messageContentScripts("parseGoogleSheetResponse",e)}),e.fetchPageComponentData){var t={search_token:e.searchToken,from_contacts:!0,from_quick_record:!0,offset:e.pageOffset};e.defaultPageId&&(t.exclude_page_ids=e.defaultPageId),APIClient.requestServer("fetchPageComponentData",t,function(o){e.response=o,messageContentScripts("fetchPageComponentDataResponse",e)},function(o){e.response={landingPages:[]},messageContentScripts("fetchPageComponentDataResponse",e)})}if(e.setDefaultPageAPI){var r={page_id:e.pageId};APIClient.requestServer("setDefaultPageAPI",r)}if(e.fetchThumbnails&&APIClient.requestServer("fetchThumbnails",{asset_id:e.assetId},function(o){e.status=!0,e.response=o,messageContentScripts("fetchThumbnailsResponse",e)},function(o){e.response={status:!1},messageContentScripts("fetchThumbnailsResponse",e)}),e.switchThumbnail&&APIClient.requestServer("switchThumbnail",{asset_id:e.assetId,thumbnail_type:e.thumbnailType},function(o){e.response=o,messageContentScripts("switchThumbnailResponse",e)}),e.initReportPop&&messageContentScripts("initReportPop",e),e.initContactActivitiesTab&&messageContentScripts("initContactActivitiesTab",e),e.fetchReportData){var i=e.contactEmail,o={contact_email:i};APIClient.fetchReportData(e.serviceName,e.offsetData,o,function(o){e.status=!0,e.response=o,messageContentScripts("fetchReportDataResponse",e)},function(o){e.status=!1,e.response=o,messageContentScripts("fetchReportDataResponse",e)})}if(e.fetchContactId){var i=e.contactEmail,o={contact_email:i};APIClient.fetchContactId(o,function(o){e.status=!0,e.response=o,messageContentScripts("fetchContactIdResponse",e)},function(o){e.status=!1,e.response=o,messageContentScripts("fetchContactIdResponse",e)})}if(e.fetchActivityData){var o={contact_email:e.contactEmail,next_start:e.next_start};APIClient.fetchActivityData(e.contactId,o,function(o){e.status=!0,e.response=o,messageContentScripts("fetchActivityDataResponse",e)},function(o){e.status=!1,e.response=o,messageContentScripts("fetchActivityDataResponse",e)})}e.initIntegOnboardingPop&&messageContentScripts("initIntegOnboardingPop",e),e.checkHubspotOnboardingStatus&&checkForHubspotOnboardingData(e),e.resetHubspotOnboardingStatus&&setHubspotOnboardingStatus(e.flowType,e.isOnboardingPreviewShown),e.trackAction&&trackUserAction(e)}function trackUserActivityMessages(e,o){KinesisUtil.pushRecord(e,o)}function trackUserAction(e){APIClient.trackHighlightsActions("action",e.actionPerformed)}function validateEmail(e){return/^\w+([\.+_-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,5})+$/.test(e)}function checkForHubspotOnboardingData(e){var o=e.flowType;chrome.storage.sync.get(["one_to_one_preview_shown","sequence_preview_shown"],function(n){"one-to-one"==o?void 0==n.one_to_one_preview_shown?getHubspotOnboardingStatus(e):(e.isOnboardingPreviewShown=n.one_to_one_preview_shown,messageHubspotOnboardingStatus(e)):"sequence"==o&&(void 0==n.sequence_preview_shown?getHubspotOnboardingStatus(e):(e.isOnboardingPreviewShown=n.sequence_preview_shown,messageHubspotOnboardingStatus(e)))})}function getHubspotOnboardingStatus(e){var o={type:e.flowType};APIClient.checkHubspotOnboardingStatus(o,function(o){e.status=!0,e.response=o,setHubspotOnboardingStatus(e.flowType,o.preview_shown),messageHubspotOnboardingStatus(e)},function(o){e.status=!1,e.response=o,messageHubspotOnboardingStatus(e)})}function setHubspotOnboardingStatus(e,o){"one-to-one"==e?chrome.storage.sync.set({one_to_one_preview_shown:o},function(){}):"sequence"==e&&chrome.storage.sync.set({sequence_preview_shown:o},function(){})}function messageHubspotOnboardingStatus(e){messageContentScripts("hubspotOnboardingStatusResponse",e)}function messageRecordingStateToContentScripts(){messageContentScripts("currentRecordingStatus",{isRecording:isRecording})}function handleGmailBackgroundMessages(e){e.checkAuthForGmail&&APIClient.isUserSignedIn(function(o){parseAuthResponse(o),messageContentScripts("gmailAuthCheckResponse",{payload:e.payload,status:o.status,authData:o,scriptName:e.scriptName})},function(o){messageContentScripts("gmailAuthCheckResponse",{payload:e.payload,status:!1,authData:o,scriptName:e.scriptName,error:!0})}),e.checkToOpenSalesFlow&&openSalesFlowInGmail[e.tabId]&&(delete openSalesFlowInGmail[e.tabId],messageContentScripts("openSalesFlow",e)),e.showSignUpPop&&messageContentScripts("showSignUpPop",{payload:e.payload}),e.insertTopMenuInGmail&&messageContentScripts("insertTopMenuInGmail",{payload:e.payload}),e.fetchNotifications&&APIClient.fetchNotifications(e.data,function(o){messageEmbedScripts("fetchNotificationsResponse",{payload:e.payload,status:!0,response:o,input:e.data})},function(o){messageEmbedScripts("fetchNotifications",{status:!1,response:o,payload:e.payload,input:e.data})}),e.getNotificationBatchCount&&APIClient.getNotificationBatchCount(e.data,function(o){messageEmbedScripts("notificationBatchCountResponse",{status:!0,response:o,payload:e.payload})},function(o){messageEmbedScripts("getNotificationBatchCount",{status:!1,response:o,payload:e.payload})}),e.markReadNotifications&&APIClient.markReadNotifications(e.data,function(e){messageEmbedScripts("markReadNotifications",{status:!0,response:e})},function(e){messageEmbedScripts("markReadNotifications",{status:!1,response:e})}),e.showGmailBannerAlert&&messageContentScripts("showGmailBannerAlert",{payload:e.payload}),e.showGmailReports&&messageContentScripts("showGmailReports",{payload:e.payload}),e.askToRefreshGmail&&messageContentScripts("askToRefreshGmail",{payload:e.payload}),e.requestBriefGmailReports&&APIClient.requestServer("briefGmailReports",void 0,function(o){messageContentScripts("briefGmailReportsResponse",{status:!0,response:o,payload:e.payload})},function(o){messageContentScripts("briefGmailReportsResponse",{status:!1,payload:e.payload})}),e.openGmailComposeBox&&messageContentScripts("openGmailComposeBox",{payload:e.payload}),e.requestGmailReports&&APIClient.requestServer("gmailReports",e.data,function(o){messageContentScripts("gmailReportsResponse",{status:!0,response:o,inputData:e.data,payload:e.payload})},function(o){messageContentScripts("gmailReportsResponse",{status:!1,error:o,inputData:e.data,payload:e.payload})}),e.requestCampaignsList&&APIClient.requestServer("campaignsList",e.data,function(o){messageContentScripts("campaignsListResponse",{status:!0,response:o,payload:e.payload})},function(o){messageContentScripts("campaignsListResponse",{status:!1,payload:e.payload})}),e.requestCampaignSpecificReport&&APIClient.requestServer("campaignSpecificReport",e.data.params,function(o){messageContentScripts("campaignSpecificReportResponse",{status:!0,response:o,campaign_name:e.data.campaign_name,campaign_id:e.data.params.campaign_id,is_parent_campaign:e.data.is_parent_campaign,payload:e.payload})},function(o){messageContentScripts("campaignSpecificReportResponse",{status:!1,campaign_name:e.data.campaign_name,campaign_id:e.data.params.campaign_id,is_parent_campaign:e.data.is_parent_campaign,payload:e.payload})}),e.requestCampaignMailIds&&APIClient.requestServer("campaignMailIds",e.data,function(o){messageContentScripts("openVideoCampaignCompose",{status:!0,response:o,payload:e.payload})},function(o){messageContentScripts("openVideoCampaignCompose",{status:!1,payload:e.payload})}),e.showCampaignReports&&messageContentScripts("showCampaignReports",{payload:e.payload}),e.openGmailPop&&messageContentScripts("openGmailPop",{payload:e.payload}),e.getUTMToken&&APIClient.getUTMToken("","gmail",e.params,function(o){e.content.utm_content=o.utm_token,e.content.thumbnailPersonalised=o.thumbnail_personalised,e.content.thumbnail_url=o.thumbnail_url,e.content.thread_id=e.params.thread_id,e.content.legacy_thread_id=e.params.legacy_thread_id,e.content.message_id=e.params.message_id,e.status=!0,messageEmbedScripts("insertVideoInComposeBox",e)},function(o){e.status=!1,messageContentScripts("insertVideoInComposeBox",e)}),e.saveMailMetaData&&APIClient.requestServer("saveMailMetaData",e.params),e.fetchGmailAccounts&&APIClient.requestServer("fetchGmailAccounts",void 0,function(o){e.status=!0,e.response=o,messageContentScripts("fetchGmailAccountsResponse",e)},function(o){e.status=!1,messageContentScripts("fetchGmailAccountsResponse",e)}),e.configureGmailAccount&&APIClient.requestServer("configureGmailApp",{auth_code:e.authcode,scopes:e.scopes},function(o){e.status=!0,e.response=o,messageContentScripts("configureGmailAppResponse",e)},function(o){e.status=!1,messageContentScripts("configureGmailAppResponse",e)}),e.sendVideoCampaign&&APIClient.requestServer("sendMail",e.params,function(o){e.status=!0,e.response=o,messageContentScripts("sendMailResponse",e)},function(o){e.status=!1,e.error=o,messageContentScripts("sendMailResponse",e)}),e.getVideoToBeAttached&&(e.videoToBeAttached=videoToBeAttached,messageEmbedScripts("video-to-be-attached",e),videoToBeAttached=void 0)}function handleGenericIntegsBackgroundMessages(e){var o={linkedin_dynamic:"insertVideoInLinkedinChatBox",outreach_dynamic:"insertVideoInOutreachMailBox",trello_dynamic:"insertVideoInTrelloCommentBox",outlook_dynamic:"insertVideoInOutlookMailBox",phoneburner_dynamic:"insertVideoInPhoneburnerMailBox",pipedrive_dynamic:"insertVideoInPipedriveMailBox",intercom_dynamic:"insertVideoInIntercomChatBox",google_classroom_dynamic:"insertVideoInGClassroomPost",hubspot_dynamic:"insertVideoInHubspotMailBox",freshchat_dynamic:"insertVideoInFreshchatChatBox",salesloft_dynamic:"insertVideoInSalesloft",freshsales_dynamic:"insertVideoInFreshsales",apollo_dynamic:"insertVideoInApollo",workable_dynamic:"insertVideoInWorkable",outplay_dynamic:"insertVideoInOutplay",zoho_crm_dynamic:"insertVideoInZohoCrm",jira_dynamic:"insertVideoInJiraCommentBox",get_utm_token:"insertVideoViaGenericScript",datazoic_dynamic:"insertVideoInDatazoicMailBox",saleshandy_dynamic:"insertVideoInSaleshandy",groove_dynamic:"insertVideoInGroove"},n={outreach:"outreach_dynamic"};if(e.getUTMToken){var t=e.content.assetContent.deliveryToken,r=constructTrackingReqParam(e),i="get_utm_token"==e.messageType?n[e.serviceName]:e.messageType;APIClient.getUTMToken(t,i,r,function(n){e.track_id=n.token,e.status=n.status,messageEmbedScripts(o[e.messageType],e)},function(n){e.status=!1,messageContentScripts(o[e.messageType],e)})}}function handleSalesforceBackgroundMessages(e){if(e.getUTMToken){var o=e.content.assetContent.deliveryToken,n=constructTrackingReqParam(e);n.sf_module=e.sfModule,APIClient.getUTMToken(o,"salesforce_dynamic",n,function(o){e.track_data=o,e.status=!0,messageEmbedScripts("insertVideoInSalesforceMailBox",e)},function(o){e.track_data=o,e.status=!1,messageContentScripts("insertVideoInSalesforceMailBox",e)})}else if(e.getLeadMailId){var t=e.leadId,r=e.columnObject,n={lead_id:t,object:r};APIClient.getSalesforceLeadData(n,function(o){e.response=o,e.leadInfoFromDom=e.leadInfoFromDom,e.status=!0,messageEmbedScripts("gotLeadMailIdFromSalesforce",e)},function(o){e.status=!1,e.leadInfoFromDom=e.leadInfoFromDom,messageContentScripts("gotLeadMailIdFromSalesforce",e)})}else e.insertCkEditorScripts?chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/hv_ckeditor.js",allFrames:!0}):e.ckeditorAction&&messageContentScripts(e)}function handleMailshakeBackgroundMessages(e){e.injectIframeScript?chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/mailshake_editor.js",allFrames:!0}):e.mailshakeEditorAction&&messageContentScripts(e)}function handleDynamics365BackgroundMessages(e){e.injectIframeHandler&&chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/dynamics-365-iframe-handler.js",allFrames:!0})}function handleOutreachBackgroundMessages(e){e.injectIframeHandler&&chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/outreach-iframe-handler.js",allFrames:!0})}function handleZohoCrmBackgroundMessages(e){e.injectIframeScript&&chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/zoho_crm_iframe_handler.js",allFrames:!0})}function handleHubspotBackgroundMessages(e){e.injectIframeScript&&chrome.tabs.executeScript(e.tabId,{file:"js/dynamicintegration/hubspot_iframe_handler.js",allFrames:!0})}function constructTrackingReqParam(e){return{is_page:e.content.assetContent.isPage,page_asset_id:e.content.assetContent.pageAssetId,form_data:e.content.assetContent.mfFormValues}}function googleSignup(){chrome.identity.getAuthToken({interactive:!0},function(e){if(chrome.runtime.lastError)return void console.error("Error while trying to signup/signin with google authtoken",{error:chrome.runtime.lastError.message});var o=new XMLHttpRequest;o.open("GET","https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+e),o.onload=function(){var n=JSON.parse(o.response),t=n.email;console.info("Google signup",{email:t}),APIClient.googleSignup(t,e,function(e){if(console.info("Google signup response",{response:e,status:e.status}),e.status){console.info("Google signup success");var o=e.auth_token;chrome.storage.sync.set({wizAuthToken:o,wizUserEmail:t,wizPlanName:constants.FREEPLAN,wizDigest:""},function(){LoggingUtils.userEmailId=t,LoggingUtils.userId=e.user_id;var n=(new Date).toISOString(),r=chrome.runtime.getManifest().version+" : "+n+" : googleSignup-"+t+"-"+o,i=[];i.push({authoringAssetId:"",stackTrace:r}),console.info("Google signup storage set success",{details:i}),messageContentScripts("google-signup-success"),chrome.storage.sync.get(["showWelcomePage"],function(e){if(console.info("Google signup show welcome page",{welcomeObject:e,showWelcomePage:e.showWelcomePage}),void 0==e.showWelcomePage){var o=chrome.extension.getURL("html/injected/welcome.html");chrome.tabs.create({url:o}),chrome.storage.sync.set({showWelcomePage:!1})}})})}},function(e){console.error("Google signup error",{error:e})})},o.send()})}function signout(){chrome.storage.sync.set({wizAuthToken:"",wizUserEmail:"",wizPlanName:"",wizUserId:""},function(){LoggingUtils.userEmailId=void 0,LoggingUtils.userId=void 0,APIClient.signout(function(e){console.info("signout success",{success:e})},function(e){console.info("signout failed",{error:e})});try{googleSignout()}catch(e){}})}function googleSignout(){chrome.identity.getAuthToken(function(e){if(chrome.runtime.lastError)return void console.error("Google signout error",{error:chrome.runtime.lastError.message});void 0!=e&&chrome.identity.removeCachedAuthToken({token:e},function(){var o=new XMLHttpRequest;o.open("GET","https://accounts.google.com/o/oauth2/revoke?token="+e),o.onload=function(){},o.send()})})}function messageEmbedScripts(e,o,n){var t={};t.backgroundRecordingMessage=e,t.data=o,t.popupTabId=n||(recordingConfiguration&&recordingConfiguration.fromPopup?n:void 0),recordingConfiguration&&recordingConfiguration.initiatorType&&(t.initiatorType=recordingConfiguration.initiatorType);for(var r=0;r<allPorts.length;r++)try{allPorts[r].postMessage(t)}catch(e){}}function messageExternal(e,o,n){for(var t={relayMessage:!0,to:e,from:"extension",type:o,data:n},r=0;r<allPorts.length;r++)try{allPorts[r].postMessage(t)}catch(e){}}function setWindowAndTabInfoForDynamicInteg(e,o,n){chrome.tabs.sendMessage(n,{},void 0,function(){var t="";t+=constructInputElement("hvIntegName",e),t+=constructInputElement("hvWindowId",o),t+=constructInputElement("hvTabId",n),chrome.tabs.executeScript(n,{code:t},function(e){console.silent("setWindowAndTabInfoForDynamicInteg",{response:e})})})}function constructInputElement(e,o){return"if(!document.getElementById('"+e+"')) {var ip1 = document.createElement('input');ip1.setAttribute('type', 'hidden');ip1.setAttribute('id', '"+e+"');ip1.setAttribute('value', '"+o+"');document.body.appendChild(ip1);}"}function injectScriptAndCss(e,o,n,t,r){var i=constructScriptJsonArray(t,o),a="number"==typeof o?{frameId:o}:void 0;recordingConfiguration&&recordingConfiguration.tabRecording?showCameraOnOtherTabs=recordingConfiguration.recordingTabId==e:!recordingConfiguration||recordingConfiguration.screenRecord&&!recordingConfiguration.showWebcamTour||(showCameraOnOtherTabs=!1),chrome.tabs.sendMessage(e,{ping:"hello",tabId:e,recordingConfiguration:recordingConfiguration,showCameraOnOtherTabs:showCameraOnOtherTabs&&isRecording,isRecording:isRecording},a,function(t){if(t&&"record-widget"!=n&&"google-slides"!=n&&"preview-iframe"!=n&&"slack"!=n&&"google-classroom"!=n&&"gmail"!=n);else try{if(executeScripts(e,i),r)for(var a=r.length,s=0;s<a;s++){var c={file:r[s]};o&&(isLessonly?c.allFrames=!0:c.frameId=o),chrome.tabs.insertCSS(e,c),checkChromeRuntimeError("css injection")}}catch(e){console.silent("error injecting scripts and css",{type:n,error:e})}})}function constructScriptJsonArray(e,o){for(var n=[],t=e.length,r=0;r<t;r++){var i={file:e[r]};o&&(isLessonly?i.allFrames=!0:i.frameId=o),n.push(i)}return n}function insertDynamicIntegScripts(e,o,n){void 0==dynamicIntegrationsFiles[o]&&populateDynamicIntegFiles(o),injectScriptAndCss(e,void 0,o,dynamicIntegrationsFiles[o].scriptArray,dynamicIntegrationsFiles[o].cssArray),setWindowAndTabInfoForDynamicInteg(o,n,e)}function populateDynamicIntegFiles(e){var o=["linkedin","phoneburner-dynamic"],n=["pardot-dynamic","hubspot-dynamic","intercom-dynamic","outreach","salesloft-dynamic","workable-dynamic","outplay-dynamic","dynamics-365-dynamic","zoho-crm-dynamic","saleshandy-dynamic","groove-dynamic"],t=["google-slides","google-document","google-classroom","slack","freshchat","google-drive","jira"],r=["js/common/jquery-3.1.1.min.js"];if(console.log(genericIntegWidgets),console.log(e),genericIntegWidgets&&genericIntegWidgets[e])console.log("generic script...."),r.push("js/dynamicintegration/generic_integration_script/generic_widget_script.js");else{console.log("native script...."),r.push("js/dynamicintegration/"+e+".js");var i=["css/"+e+".css"]}"d2l"==e&&(r=["js/common/jquery-3.1.1.min.js","js/common/jquery-ui.min.js","js/common/content-script.js","js/dynamicintegration/"+e+".js"],i=["css/content-css.css","css/"+e+".css","css/recordandlibrarywidget.css","css/jquery-ui.min.css"]),"gmail"==e&&(r=["js/common/jquery-3.1.1.min.js","js/dynamicintegration/"+e+".js","js/dynamicintegration/gmail-top-menu.js","js/dynamicintegration/gmail-reports.js"]),n.includes(e)&&r.push("js/common/clipboard.min.js"),t.includes(e)&&(r.push("js/common/jquery-ui.min.js","js/common/content-script.js"),i.push("css/jquery-ui.min.css","css/content-css.css","css/record-library-widget.css")),o.includes(e)&&(r.push("js/common/jquery-ui.min.js"),i.push("css/jquery-ui.min.css")),dynamicIntegrationsFiles[e]={scriptArray:r,cssArray:i}}function insertRecordAndLibScript(e){injectScriptAndCss(e,void 0,"record-widget",["js/common/recordandlibrarywidget.js","js/bg/aws-sdk.min.js","js/bg/S3Uploader.js"])}function insertRecordLibraryScript(e){injectScriptAndCss(e,void 0,"record-widget",["js/common/record-library-widget.js","js/bg/aws-sdk.min.js","js/bg/S3Uploader.js"])}function insertRecordScript(e){injectScriptAndCss(e,void 0,"record-widget",["js/common/recordwidget.js","js/bg/aws-sdk.min.js","js/bg/S3Uploader.js"])}function insertPreviewPopupScript(e){injectScriptAndCss(e,void 0,"preview-iframe",["js/common/inject-preview-iframe.js"])}function injectWfPreviewPopScripts(e){injectScriptAndCss(e,void 0,"preview-iframe",["js/dynamicintegration/inject-wf-preview-iframe.js"])}function executeScripts(e,o){for(var n=null,t=o.length-1;t>=0;--t)n=function(e,o,n){return function(){
chrome.tabs.executeScript(e,o,n),checkChromeRuntimeError("content script injection")}}(e,o[t],n);null!==n&&n()}function handleUpdateInGoogleAccessTab(e){-1!==e.url.indexOf("code=")?closeGoogleAccessTab(e,"code"):-1!==e.url.indexOf("error=")&&closeGoogleAccessTab(e,"error")}function closeGoogleAccessTab(e,o){var n=gup(e.url,o);if(googleAccessTabId&&gmailTabId){var t=googleAccessTabId;googleAccessTabId=void 0,chrome.tabs.remove(t),chrome.tabs.update(gmailTabId,{highlighted:!0}),gmailTabId=void 0,"code"==o&&googleAccessResponse?(googleAccessResponse.status=!0,googleAccessResponse.authcode=n):googleAccessResponse.status=!1,messageContentScripts("googleAccessResponse",googleAccessResponse),googleAccessResponse=void 0}}function insertContentScripts(e,o){injectScriptAndCss(e,o,"content-script",["js/common/jquery-3.1.1.min.js","js/common/jquery-ui.min.js","js/common/content-script.js","js/bg/aws-sdk.min.js","js/bg/S3Uploader.js"],["css/content-css.css","css/jquery-ui.min.css"])}function insertAllSitesScript(e,o){var n=["js/common/allsites-script.js"],t=constructScriptJsonArray(n,o);try{executeScripts(e,t)}catch(e){console.error("error injecting allsites-script",{error:e})}}function stopBackgroundRecording(e){if(disableLessonlyBrowserAction(),highlightsEvents.allow&&(highlightsEvents.asset_id=recordingConfiguration.assetId,APIClient.trackHighlightsActions("highlight",highlightsEvents)),highlightsEvents={hvColorChoose:0,hvCloseHighlight:0,hvOpenHighlight:0,hvClearScreen:0,hvEraser:0,hvPen:0,hvFocusArea:0,hvCursor:0,allow:!1,asset_id:null,current_action:null,hvCursorAnimation:0,hvWebCam:0},clearTimeout(autoFinishTimeout),!recordingConfiguration.stopped){if(recordingConfiguration.stopped=!0,isRecording=!1,messageRecordingStateToContentScripts(),recordingConfiguration.countdownComplete||recordingConfiguration.error||(APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("NOTHING_RECORDED")),completeWithError(CommonUtils.getError("NOTHING_RECORDED"))),void 0==e||0==e.blameUser){var o="gmail"===recordingConfiguration.initiator&&"add-on"===recordingConfiguration.initiatorType;if("popup"==recordingConfiguration.initiator||"google-slides"==recordingConfiguration.initiator||"d2l"==recordingConfiguration.initiator||o)if(o&&chrome.tabs.remove(initiatorTabId),uploadError)console.info("SHOWING UPLOAD STATUS ON UPLOAD ERROR"),showUploadStatusPage();else{var n=server+"/prospect/video?from=extension&action=show_draft_video&assetId="+recordingConfiguration.assetId;changeRedirectUrl&&(n=server+"/video/view/"+recordingConfiguration.assetId+"?from=popup&tcv=true"),chrome.tabs.create({url:n},function(e){insertContentScripts(e.id)})}}stopBackgroundScreen(),stopBackgroundWebcam(),is_guest_user||askAccountConfirmation||copyToClipBoard(recordingConfiguration.recordedPagedURL?recordingConfiguration.recordedPagedURL:recordingConfiguration.newShareURL?recordingConfiguration.newShareURL:recordingConfiguration.recordedURL),checkAndSendStopRecordingMsg(recordingConfiguration),timer&&clearTimeout(timer),setBadgeText(""),chrome.browserAction.setTitle({title:"Hippo Video"})}}function cancelBackgroundRecording(){chrome.storage.sync.get(["dynamicIntegConfigurations"],function(e){if(e&&e.dynamicIntegConfigurations){if(disableLessonlyBrowserAction(),highlightsEvents.allow&&(highlightsEvents.asset_id=recordingConfiguration.assetId,APIClient.trackHighlightsActions("highlight",highlightsEvents)),highlightsEvents={hvColorChoose:0,hvCloseHighlight:0,hvOpenHighlight:0,hvClearScreen:0,hvEraser:0,hvPen:0,hvFocusArea:0,hvCursor:0,allow:!1,asset_id:null,current_action:null,hvCursorAnimation:0,hvWebCam:0},clearTimeout(autoFinishTimeout),recordingConfiguration.stopped)return;recordingConfiguration.stopped=!0,recordingConfiguration.cancelled=!0,fileUploadManager.checkAndCancelUploads(),isRecording=!1,isPaused=!1,console.info("cancelBackgroundRecording called"),onCompleteHandler(),chrome.storage.local.remove(["incomplete_upload_asset","recording_not_complete","pending_actions"]),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("VIDEO_CANCELLED")),e.dynamicIntegConfigurations.hasOwnProperty(recordingConfiguration.initiator)&&(previewIframeData={initiator:recordingConfiguration.initiator,recordConfiguration:recordingConfiguration}),messageContentScripts("record_aborted",previewIframeData),previewIframeData=void 0,timer&&clearTimeout(timer),setBadgeText(""),stopBackgroundScreen(),stopBackgroundWebcam(),chrome.browserAction.setTitle({title:"Hippo Video"}),setTimeout(function(){setDefaults()},1e3)}})}function retakeRecording(){chrome.storage.sync.get(["dynamicIntegConfigurations"],function(e){if(e&&e.dynamicIntegConfigurations){if(isRecording)return;resetRecording(),fileUploadManager&&fileUploadManager.checkAndCancelUploads(),recordingConfiguration.completed=!0,recordingConfiguration.cancelled=!0,webcamStream=null,chrome.storage.local.remove(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(){}),setTimeout(function(){setDefaults()},1e3)}})}function stopBackgroundScreen(){if(isPaused&&resumeBackgroundRecording(),isRecording=!1,messageRecordingStateToContentScripts(),recordingConfiguration.screenRecord){try{recorder.stop()}catch(e){console.error("error while trying to stop recording",{error:e}),recordingConfiguration.error||recordingConfiguration.cancelled||APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("NO_DATA_AVAILABLE"))}screenStream&&screenStream.getTracks()[0]&&screenStream.getTracks()[0].stop(),screenStream&&screenStream.getTracks()[1]&&screenStream.getTracks()[1].stop(),screenStream=null}}function stopBackgroundWebcam(){if(isRecording=!1,messageRecordingStateToContentScripts(),webcamRecorder&&(recordingConfiguration.audio||recordingConfiguration.webCam)){messageContentScripts("removeIframe");try{webcamRecorder.stop()}catch(e){console.error("stop webcam error",{error:e})}webcamStream&&webcamStream.getTracks()[0]&&webcamStream.getTracks()[0].stop(),webcamStream&&webcamStream.getTracks()[1]&&webcamStream.getTracks()[1].stop(),webcamStream=null}else recordingConfiguration.pseudoWebcam&&messageContentScripts("removeIframe")}function bothStarted(){console.info("both started"),recordingConfiguration.status.webcam="uploading",chrome.storage.sync.get(["highlightsOnboardingShowed","webcamTourShown"],function(e){if(1!=e.highlightsOnboardingShowed&&"generic_embed"!=recordingConfiguration.initiator&&"lessonly"!=recordingConfiguration.initiator&&(recordingConfiguration.showHighlightsOnboarding=!0),recordingConfiguration.showWebcamTour=!1,1!=recordingConfiguration.pseudoWebcam||void 0!=e.webcamTourShown&&1==e.webcamTourShown||"generic_embed"==recordingConfiguration.initiator||"lessonly"==recordingConfiguration.initiator||(recordingConfiguration.showWebcamTour=!0,recordingConfiguration.showHighlightsOnboarding=!1),!recordingConfiguration.showWebcamTour&&"google-slides"!=recordingConfiguration.initiator){var o=1e3;recordingConfiguration.availableForCountdown&&(o=7e3),forceStartTimeout=setTimeout(function(){recordingConfiguration.countdownComplete=!0,console.info("force starting without countdown"),checkAndStartRecording()},o)}messageContentScripts("hippo-website"==recordingConfiguration.initiator?"bothstarted":"bothstarted-"+recordingConfiguration.initiator,recordingConfiguration),chrome.storage.sync.set({highlightsOnboardingShowed:!0})}),isRecording=!0,messageRecordingStateToContentScripts()}function checkAndStartRecording(){if(console.info("checkAndStartRecording called",{recordingConfiguration:JSON.stringify(recordingConfiguration)}),!recordingConfiguration.error&&!recordingConfiguration.startedRecording&&recordingConfiguration.countdownComplete&&"uploading"==recordingConfiguration.status.webcam&&"uploading"==recordingConfiguration.status.screen){console.info("checkAndStartRecording going to record"),recordingConfiguration.startedRecording=!0,initialTime=Date.now(),timer=setInterval(checkTime,100);var e=0;if(recordingConfiguration.screen&&e++,(recordingConfiguration.webCam||recordingConfiguration.audio)&&e++,dataStreamer=new DataStreamer(recordingConfiguration.initiator,initiatorTabId,e,5242880),autoFinishTimeout=setTimeout(function(){stopBackgroundRecording(),showUpgradeNotification("You can only record upto "+recordingConfiguration.allowedTimeToRecord/6e4+" minutes.."),console.warn("checkAndStartRecording record limit reached",{recordLimit:recordingConfiguration.allowedTimeToRecord/6e4})},recordingConfiguration.allowedTimeToRecord),recordingConfiguration.screenRecord){try{recorder.start(1e3)}catch(e){console.error("checkAndStartRecording error starting screenrecorder",{error:e}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("STARTING_FAILED")),recordingConfiguration.error=!0,stopBackgroundRecording(CommonUtils.getError("STARTING_FAILED")),completeWithError(CommonUtils.getError("STARTING_FAILED"))}screenUploader.recordingStarted()}if(recordingConfiguration.audio||recordingConfiguration.webCam){try{webcamRecorder.start(1e3)}catch(e){console.error("checkAndStartRecording error starting webcamrecorder",{error:JSON.stringify(e)}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("STARTING_FAILED")),recordingConfiguration.error=!0,stopBackgroundRecording(CommonUtils.getError("STARTING_FAILED")),completeWithError(CommonUtils.getError("STARTING_FAILED"))}webcamUploader.recordingStarted()}messageContentScripts("recording_data_started",initialTime)}}function blobSentToWebsite(){return recordingConfiguration.screenRecord&&!recordingOutput.screenBlobSent?void console.warn("cant send proceed without sceenrecord"):!recordingConfiguration.audio&&!recordingConfiguration.webCam||recordingOutput.webcamBlobSent?(askWebsiteToProceed(),void console.info("asking user to proceed",{recordingConfiguration:recordingConfiguration})):void console.warn("cant send proceed without webcam")}function checkAndProceed(){return recordingConfiguration.screenRecord&&!recordingOutput.screenDataAvailable?void console.info("checkAndProceed cant proceed without sceenrecord"):!recordingConfiguration.audio&&!recordingConfiguration.webCam||recordingOutput.webcamDataAvailable?(recordingConfiguration.allDataAvailable=!0,chrome.storage.local.remove(["recording_not_complete"]),void console.info("checkAndProceed proceeding",{recordingConfiguration:recordingConfiguration})):void console.info("checkAndProceed cant proceed without webcam")}function doBackgroundWebcam(){if(recordingConfiguration.status.screen="uploading",console.info("doBackgroundWebcam asking to do webcamrecording",{recordingConfiguration:recordingConfiguration}),recordingConfiguration.audio||recordingConfiguration.webCam){var e=!1;recordingConfiguration.webCam&&(e={width:{ideal:1280,max:1280},height:{ideal:720,max:720},frameRate:videoFrameRate,aspectRatio:getAspectRatio()},7e3!=recordingConfiguration.webcamBitRate||recordingConfiguration.screenRecord||(e.width={ideal:1920,max:1920},e.height={ideal:1080,max:1080}),recordingConfiguration.webcamSource&&(e.deviceId=recordingConfiguration.webcamSource),recordingConfiguration.aspectRatio&&"Default"!=recordingConfiguration.aspectRatio&&(e.aspectRatio=recordingConfiguration.aspectRatio));var o=recordingConfiguration.audio;recordingConfiguration.audio&&recordingConfiguration.audioSource&&(o={optional:[{sourceId:recordingConfiguration.audioSource}]}),console.info("doBackgroundWebcam webcam and audio contrains",{videoConstraints:e,audioContraints:o}),navigator.mediaDevices.getUserMedia({audio:o,video:e}).then(function(n){n.getTracks()[0]&&n.getTracks()[0].stop(),n.getTracks()[1]&&n.getTracks()[1].stop(),messageContentScripts("requestedwebcam"),console.info("started recording",{audio:recordingConfiguration.audio,webcam:recordingConfiguration.webCam}),webcamUploader=new S3Uploader("webcam",recordingConfiguration.webcam.id,recordingConfiguration.webcam.bucket,recordingConfiguration.webcam.key,"private",6e4,s3Logger,s3ErrorHandler,recordingConfiguration.assetId,useAccelerate),setTimeout(function(){navigator.mediaDevices.getUserMedia({audio:o,video:e}).then(function(e){if(console.info("GOT STREAM FROM SECOND GETUSERMEDIA"),messageContentScripts("startedwebcam"),webcamStream=e,recordingConfiguration.audio){webcamStream.getAudioTracks()[0].onmute=function(){console.info("[AUDIO_MUTED] webcam audio stream muted")},webcamStream.getAudioTracks()[0].onunmute=function(){console.info("[AUDIO_UNMUTED] webcam audio stream unmuted")};try{var o=CommonUtils.getAudioMeter(webcamStream);CommonUtils.checkFaultyMic(o,function(){chrome.storage.sync.get(["wizUserEmail"],function(e){var o=e.wizUserEmail;console.info("[FAULTY_MIC_SOURCE_WHILE_RECORDING]",{userEmail:o})})})}catch(e){console.log("GET AUDIO METER ERR ",e)}}var n={mimeType:getSupportedMimeType()};if(recordingConfiguration.webcamBitRate&&(n.videoBitsPerSecond=1e3*recordingConfiguration.webcamBitRate),webcamRecorder=new MediaRecorder(webcamStream,n),webcamRecorder.onstart=function(e){recordingConfiguration.startWebCamTime||(recordingConfiguration.startWebCamTime=Date.now())},webcamRecorder.ondataavailable=function(e){webcamUploader.onDataAvailable(webcamUploader,e.data),dataStreamer.onDataAvailable("webcamdata",e.data)},webcamRecorder.onstop=function(e){console.info("webcamrecording on stop called"),setTimeout(function(){"popup"!=recordingConfiguration.initiator&&"generic_embed"!=recordingConfiguration.initiator&&"lessonly"!=recordingConfiguration.initiator&&initiatorTabId&&(console.log("calling sendFromLocalVideo"),CommonUtils.sendFromLocalVideo("webcamdata",uploadObject.webcamId,262144,initiatorTabId,function(){console.info("check and proceed called"),recordingOutput.webcamBlobSent=!0,blobSentToWebsite()})),dataStreamer.finish("webcamdata",function(){console.info("dataStreamer webcamdata finished"),askWebsiteToProceed()}),recordingOutput.webcamDataAvailable=!0,checkAndProceed()},"generic_embed"==recordingConfiguration.initiator||"lessonly"==recordingConfiguration.initiator?0:1e3),webcamUploader.finish(function(e){console.info("webcamUploader finish",{result:e}),0!=e.status&&(recordingConfiguration.status.webcam="uploaded",uploadedVideo())}),console.info("finished webcam available"),setTimeout(function(){setDefaults()},1e3)},webcamRecorder.onstart=function(){console.info("webcamrecording on start called")},webcamStream.getVideoTracks()&&webcamStream.getVideoTracks()[0]){var t=document.createElement("video");t.srcObject=webcamStream,t.muted=!0,t.onloadedmetadata=function(){recordingConfiguration.sourceConfig||(recordingConfiguration.sourceConfig={}),recordingConfiguration.sourceConfig.webcam={width:this.videoWidth,height:this.videoHeight},URL.revokeObjectURL(t.src),t.pause(),t.srcObject="",t.load()}}console.info("calling checkAndStartRecording from function doBackgroundWebcam"),checkAndStartRecording(),bothStarted()}).catch(function(e){console.error("inner navigator.getUserMedia",{error_name:e.name,error_message:e.message,error_stack:e.stack})})},500),fileUploadManager.addUploader(webcamUploader)}).catch(function(e){var o="UNKNOWN_WEBCAM_ERROR";e?(console.error("outer navigator.getUserMedia",{error_name:e.name,error_message:e.message,error_stack:e.stack,rec_config_asset_id:recordingConfiguration.assetId}),"NotAllowedError"==e.name&&(o="Permission denied by system"==e.message?"SYSTEM_WEBCAM_PERMISSION_DENIED":"Failed due to shutdown"==e.message?"WEBCAM_INPUT_ERROR":"WEBCAM_PERMISSION_DENIED"),"NotReadableError"==e.name&&(o="WEBCAM_READ_ERROR"),"NotFoundError"==e.name&&(o="WEBCAM_NOT_FOUND")):console.error("outer navigator.getUserMedia error : error is empty"),recordingConfiguration.error=!0,completeWithError(CommonUtils.getError(o)),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError(o)),stopBackgroundRecording(CommonUtils.getError(o))})}else bothStarted()}function getSupportedMimeType(){var e="video/webm;codecs=h264";return MediaRecorder.isTypeSupported(e)||(e="video/webm",MediaRecorder.isTypeSupported(e)||(e="")),console.info("SUPPORTED MIMETYPE : "+e),e}function doBackgroundScreen(){if(console.info("doBackgroundScreen asking to do BackgroundScreen"),recordingOutput={},recordingConfiguration.tabRecording){messageContentScripts("requestedscreen"),chrome.browserAction.setIcon({path:"/images/extension/main-icon.png"});var e={video:!0,audio:1==recordingConfiguration.tabAudio,videoConstraints:{mandatory:{maxWidth:getMaxResolution().width,maxHeight:getMaxResolution().height}}};chrome.tabs.getSelected(null,function(o){recordingConfiguration.recordingTabId=o.id,chrome.tabCapture.capture(e,onTabStreamAvailable)})}else if(recordingConfiguration.screenRecord){if(screenStream&&screenStream.onended)return console.info("doBackgroundScreen stopping previous unfinished recording"),void screenStream.onended();messageContentScripts("requestedscreen"),chrome.browserAction.setIcon({path:"/images/extension/main-icon.png"});var o=["screen","window"];1==recordingConfiguration.systemAudio&&o.push("audio"),enableTabAudio&&(o=["tab","audio"]);try{APIClient.updateAuthorState(recordingConfiguration.assetId,constants.errorType.SCREEN_PERMISSION_REQUESTED),chooseDesktopMediaReqId=chrome.desktopCapture.chooseDesktopMedia(o,onAccessApproved),messageContentScripts("screenpopopened"),console.info("doBackgroundScreen waiting for screenrecord permission from user"),waitingForScreenPermission=!0}catch(e){console.error("doBackgroundScreen chooseDesktopMedia",{error:JSON.stringify(e)}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("SCREEN_PERMISSION_DENIED")),completeWithError(CommonUtils.getError("SCREEN_PERMISSION_DENIED")),messageContentScripts("screenpopclosed")}}else doBackgroundWebcam()}function disableLessonlyBrowserAction(){isLessonly&&chrome.browserAction.disable()}function onTabStreamAvailable(e){if(void 0==e)console.error("onTabStreamAvailable error while requesting tabRecording"),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("TAB_CANNOT_BE_RECORDED")),completeWithError(CommonUtils.getError("TAB_CANNOT_BE_RECORDED"));else if(messageContentScripts("startedscreen"),gotScreenStream(e),recordingConfiguration.tabAudio){var o=document.createElement("audio");o.srcObject=e,o.onended=function(){console.warn("Audio player is stopped.")},o.onpause=function(){console.warn("Audio player is paused.")},o.play()}}function onAccessApproved(e){if(waitingForScreenPermission=!1,chooseDesktopMediaReqId=void 0,console.info("onAccessApproved : access approved"),messageContentScripts("screenpopclosed"),!e||!e.toString().length)return getChromeVersion()<53?(console.error("chrome version less than 53",{version:getChromeVersion()}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("CHROME_NOT_SUPPORTED")),void completeWithError(CommonUtils.getError("CHROME_NOT_SUPPORTED"))):(APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("SCREEN_PERMISSION_DENIED")),console.error("onAccessApproved : permission denied"),messageContentScripts("recording_cancelled",{workflowPopId:recordingConfiguration.workflowPopId}),void completeWithError(CommonUtils.getError("SCREEN_PERMISSION_DENIED")));APIClient.updateAuthorState(recordingConfiguration.assetId,constants.errorType.SCREEN_PERMISSION_APPROVED),messageContentScripts("startedscreen");var o={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]}};videoMaxFrameRates&&videoMaxFrameRates.toString().length&&(videoMaxFrameRates=parseInt(videoMaxFrameRates))&&(o.video.maxFrameRate=videoMaxFrameRates),o.video.mandatory.maxFrameRate=24,1==recordingConfiguration.systemAudio&&(o.audio={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e},optional:[]}),resolutions.maxWidth=getMaxResolution().width,resolutions.maxHeight=getMaxResolution().height,resolutions.maxWidth&&resolutions.maxHeight&&(o.video.mandatory.maxWidth=resolutions.maxWidth,o.video.mandatory.maxHeight=resolutions.maxHeight),console.info("Going to call getUserMedia for screen"),navigator.mediaDevices.getUserMedia(o).then(gotScreenStream).catch(function(e){var o="UNKNOWN_SCREEN_ERROR";e?(console.error("error starting screen recording getUserMedia",{name:e.name,message:e.message}),"Permission denied by system"==e.message&&(o="SYSTEM_SCREEN_PERMISSION_DENIED")):console.error("error starting screen recording getUserMedia : error is empty"),recordingConfiguration.error=!0,APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError(o)),completeWithError(CommonUtils.getError(o))})}function gotScreenStream(e){if(screenStream=e,console.info("got screen stream"),void 0==e&&console.error("screen stream undefined"),e.getVideoTracks()[0]){var o=document.createElement("video");o.srcObject=e,o.muted=!0,o.onloadedmetadata=function(){recordingConfiguration.sourceConfig||(recordingConfiguration.sourceConfig={}),recordingConfiguration.sourceConfig.screen={width:this.videoWidth,height:this.videoHeight},URL.revokeObjectURL(o.src),o.pause(),o.srcObject="",o.load()}}screenUploader=new S3Uploader("screen",recordingConfiguration.screen.id,recordingConfiguration.screen.bucket,recordingConfiguration.screen.key,"private",6e4,s3Logger,s3ErrorHandler,recordingConfiguration.assetId,useAccelerate);var n={mimeType:getSupportedMimeType()};videoCodec&&"Default"!==videoCodec&&(n.mimeType="video/webm; codecs="+videoCodec.toLowerCase()),getChromeVersion()>=52&&(audioBitsPerSecond&&(audioBitsPerSecond=parseInt(audioBitsPerSecond),(!audioBitsPerSecond||audioBitsPerSecond>128)&&(audioBitsPerSecond=128),(!audioBitsPerSecond||audioBitsPerSecond<6)&&(audioBitsPerSecond=6)),enableTabAudio?(audioBitsPerSecond&&(n.audioBitsPerSecond=1e3*audioBitsPerSecond),videoBitsPerSecond&&(n.videoBitsPerSecond=1e3*Math.max(videoBitsPerSecond,100))):videoBitsPerSecond&&(n.bitsPerSecond=1e3*Math.max(videoBitsPerSecond,100))),console.info("gotScreenStream options",{options:n}),recorder=new MediaRecorder(e,n),recorder.onstart=function(e){recordingConfiguration.startScreenTime||(recordingConfiguration.startScreenTime=Date.now())},recorder.ondataavailable=function(e){screenUploader.onDataAvailable(screenUploader,e.data),dataStreamer.onDataAvailable("screendata",e.data)},recorder.onstop=function(e){console.info("gotScreenStream recorder on stop called"),setTimeout(function(){"popup"!=recordingConfiguration.initiator&&"generic_embed"!=recordingConfiguration.initiator&&"lessonly"!=recordingConfiguration.initiator&&initiatorTabId&&(console.info("gotScreenStream calling sendFromLocalVideo"),CommonUtils.sendFromLocalVideo("screendata",uploadObject.screenId,262144,initiatorTabId,function(){console.info("gotScreenStream check and proceed called"),recordingOutput.screenBlobSent=!0,blobSentToWebsite()})),dataStreamer.finish("screendata",function(){console.info("gotScreenStream dataStreamer screendata finished"),askWebsiteToProceed()}),recordingOutput.screenDataAvailable=!0,checkAndProceed()},"generic_embed"==recordingConfiguration.initiator||"lessonly"==recordingConfiguration.initiator?0:1e3),screenUploader.finish(function(e){console.info("gotScreenStream screenuploader finish response",{result:e}),0!=e.status&&(recordingConfiguration.status.screen="uploaded",uploadedVideo())}),setTimeout(function(){setDefaults()},1e3)},screenStream.onended=function(){console.info("gotScreenStream screen stream stopped externally"),screenStream&&(screenStream.onended=function(){}),recordingConfiguration&&recordingConfiguration.showWebcamTour?(recordingConfiguration.showWebcamTour=!1,cancelBackgroundRecording(),messageContentScripts("stopWebcamTour",{stopRecording:!0})):stopBackgroundRecording()},screenStream.getVideoTracks()[0].onended=function(){screenStream&&screenStream.onended&&screenStream.onended()},screenStream.getVideoTracks()[0].onmute=function(){console.info("screen stream muted")},screenStream.getVideoTracks()[0].onunmute=function(){console.info("gotScreenStream screen stream unmuted")},recordingConfiguration.error&&("function"==typeof screenStream.stop?screenStream.stop():console.warn("screenStream.stop not a function")),console.info("gotScreenStream screen recorder initialized"),doBackgroundWebcam(),fileUploadManager.addUploader(screenUploader)}function doBackgroundRecording(){recordingConfiguration.fromPopup&&chrome.tabs.query({active:!0,currentWindow:!0},function(e){var o;e.length>0&&(o=e[0]),o&&(popupTabId=o.id,console.info("doBackgroundRecording tab_url",{url:o.url}),insertContentScripts(o.id))}),void 0==recordingConfiguration.highlights&&(recordingConfiguration.highlights=!0),showCameraOnOtherTabs=!recordingConfiguration.separateLayer&&(recordingConfiguration.webCam||recordingConfiguration.pseudoWebcam),console.info("doBackgroundRecording asking to create",{recordingConfiguration:recordingConfiguration}),fileUploadManager=new FileUploadManager,resetRecording(),isRecordingInitiated=!0,recordingConfiguration.pseudoWebcam&&(recordingConfiguration.webCam=!1),APIClient.createRecording(recordingConfiguration,function(e){if(console.info("doBackgroundRecording create recording",{response:JSON.stringify(e)}),recordingConfiguration.resolution=e.resolution,recordingConfiguration.allowedTimeToRecord=e.allowed_time,askAccountConfirmation=e.ask_confirm,is_guest_user=e.is_guest_user,markupToolEnabled=e.markup_tool,e.status&&"error"==e.status)return recordingConfiguration.error=!0,showUpgradeNotification(e.message),void stopBackgroundRecording();if(0==e.status||"false"==e.status){var o="CREATE_RECORD_ERROR";return"OAuthException"==e.msg&&(o="CREATE_RECORD_AUTH_ERROR"),stopBackgroundRecording(CommonUtils.getError(o)),void completeWithError(CommonUtils.getError(o))}recordingConfiguration.authoringId=e.authoring_id,recordingConfiguration.assetId=e.authoring_asset_id,LoggingUtils.clientLogsAssetId=e.authoring_asset_id,console.info("Setting incomplete_upload_asset and recording_not_complete in local storage"),chrome.storage.local.set({incomplete_upload_asset:e.authoring_asset_id}),chrome.storage.local.set({recording_not_complete:!0}),uploadObject={type:"retryVideoUpload",assetId:e.authoring_asset_id},e.upload_screen_key&&(recordingConfiguration.screen={bucket:e.upload_bucket,key:e.upload_screen_key,id:e.screen_id},uploadObject.screenId=e.screen_id),e.upload_webcam_key&&(recordingConfiguration.webcam={bucket:e.upload_bucket,key:e.upload_webcam_key,id:e.webcam_id},uploadObject.webcamId=e.webcam_id),uploadObject.recordingConfiguration=recordingConfiguration,console.info("calling setActionAfterReload"),setActionAfterReload(uploadObject),e.url&&(recordingConfiguration.recordedURL=e.url,recordingConfiguration.recordedURLLessonly=e.lessonly_url,messageContentScripts("recorded_url",e.url)),e.default_page_url&&(recordingConfiguration.recordedPagedURL=e.default_page_url),e.new_share_url&&(recordingConfiguration.newShareURL=e.new_share_url),recordingConfiguration.deliveryToken=e.delivery_token,videoToken=e.delivery_token,console.info("doBackgroundRecording recording configuration after create request",{recordingConfiguration:recordingConfiguration}),doBackgroundScreen(),messageContentScripts("initiated_recording",{recorded_url:recordingConfiguration.recordedURLLessonly,preview_url:e.embedded_preview_link,embed_url:e.embed_link,thumbnail_url:e.public_thumbnail,thumbnail_play_url:e.public_play_thumbnail,token:e.delivery_token,thumbnail_preview:e.thumbnail_preview,asset_id:e.authoring_asset_id}),isLessonly&&chrome.browserAction.enable()},function(e){console.error("doBackgroundRecording error for create request",{error:e}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("CREATE_VIDEO_REQUEST_FAILED")),completeWithError(CommonUtils.getError("CREATE_VIDEO_REQUEST_FAILED"))}),IDBUtils.clearAllLocalVideos()}function resetRecording(){screenUploader=void 0,webcamUploader=void 0,waitingForScreenPermission=!1,chooseDesktopMediaReqId=void 0,uploadError=!1,recordedVideoOpened=!1}function pauseWebcamRecording(){(recordingConfiguration.audio||recordingConfiguration.webCam)&&webcamRecorder.pause()}function resumeWebcamRecording(){(recordingConfiguration.audio||recordingConfiguration.webCam)&&webcamRecorder.resume()}function pauseScreenRecording(){recordingConfiguration.screenRecord&&recorder.pause()}function resumeScreenRecording(){recordingConfiguration.screenRecord&&recorder.resume()}function pauseBackgroundRecording(){pauseScreenRecording(),pauseWebcamRecording(),clearTimeout(autoFinishTimeout),clearInterval(timer),chrome.browserAction.setIcon({path:"/images/injected/pause-icon.png"}),setBadgeText(""),chrome.browserAction.setTitle({title:"Paused recording"}),isPaused=!0,pauseTime=Date.now(),messageContentScripts("paused_recording")}function resumeBackgroundRecording(){chrome.browserAction.setIcon({path:"/images/extension/main-icon.png"}),initialTime+=Date.now()-pauseTime,resumeScreenRecording(),resumeWebcamRecording(),isPaused=!1,timer=setInterval(checkTime,100),autoFinishTimeout=setTimeout(function(){stopBackgroundRecording(),showUpgradeNotification("You can only record upto "+recordingConfiguration.allowedTimeToRecord/6e4+" minutes..")},recordingConfiguration.allowedTimeToRecord-(Date.now()-initialTime)),messageContentScripts("resumed_recording")}function messageContentScripts(e,o){for(var n=0;n<allPorts.length;n++)try{allPorts[n].postMessage({backgroundRecordingMessage:e,data:o,popupTabId:recordingConfiguration&&recordingConfiguration.fromPopup?popupTabId:void 0})}catch(e){}}function messageTab(e,o,n,t){var r=void 0;!t&&recordingConfiguration&&recordingConfiguration.fromPopup&&(r=popupTabId);for(var i=0;i<allPorts.length;i++)try{allPorts[i].sender.tab.id==e&&allPorts[i].postMessage({backgroundRecordingMessage:o,data:n,popupTabId:r})}catch(e){}}function askWebsiteToProceed(){recordingConfiguration.cancelled||messageContentScripts("proceed",recordingConfiguration.assetId)}function uploadedVideo(){if(recordingConfiguration.screenRecord&&"uploaded"!=recordingConfiguration.status.screen)return void console.info("uploadedVideo returning for screenrecord");if((recordingConfiguration.audio||recordingConfiguration.webCam)&&"uploaded"!=recordingConfiguration.status.webcam)return void console.info("uploadedVideo returning for webcam");if(chrome.storage.local.get("hippo_errors",function(e){var o={};e&&e.hippo_errors&&(o=e.hippo_errors,o[constants.localErrors.UPLOAD_FAILED]=0),chrome.storage.local.set({hippo_errors:o}),uploadErrorCount=0}),!recordingConfiguration.cancelled){var e=getSafeRecordingConfiguration(recordingConfiguration);chrome.storage.sync.get(["dynamicIntegConfigurations"],function(o){var n=!!(o&&o.dynamicIntegConfigurations&&o.dynamicIntegConfigurations.hasOwnProperty(recordingConfiguration.initiator));APIClient.compressVideos(e,recordingConfiguration.assetId,recordingConfiguration.webcam?recordingConfiguration.webcam.id:void 0,recordingConfiguration.screen?recordingConfiguration.screen.id:void 0,n,function(e){if(console.info("compress requested",{response:e}),0==e.status||"false"==e.status)console.error("backgroundscript - fatal error .. requesting compress redis",{compress_response:e,re_config_asset_id:recordingConfiguration.assetId}),completeWithError(CommonUtils.getError("COMPRESS_FAILED"));else{var o=e.video;void 0==o&&(o=e.video_guest),void 0==o&&(o=e.api),void 0==o&&(o=e.guest),chrome.storage.local.remove(["incomplete_upload_asset","pending_actions"]),waitAndRender(o),messageContentScripts("source_uploaded")}},function(e){console.error("uploadedVideo compress request error",{error:e}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("PREPROCESS_REQUEST_FAILED")),completeWithError(CommonUtils.getError("PREPROCESS_REQUEST_FAILED"))})})}}function waitAndRender(e){recordingConfiguration.uploadedTakes=[];var o=new StatusPoller(recordingConfiguration.assetId,4,1800,function(n){if(4==n.operationtype){console.info("waitAndRender compress complete response",{event:JSON.stringify(n)})
;var t={},r=n.data;t.id=r.id,t.duration=r.duration<0?r.audioduration:r.duration,t.type=r.videotype,t.offset=r.offset,recordingConfiguration.uploadedTakes.push(t);var i=e.pop();void 0==i?renderVideo():o.startPollingForStatus(i)}else console.info("waitAndRender rendered video",{link:n.data.link})},function(e){console.error("error while compressing",{err:JSON.stringify(e)}),62==(e&&e.data&&e.data.errorState?e.data.errorState:-1)?completeWithError(CommonUtils.getError("INVALID_INPUT_DURATION_ERROR")):(APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("PREPROCESS_FAILED")),completeWithError(CommonUtils.getError("PREPROCESS_FAILED")))}),n=e.pop();o.startPollingForStatus(n)}function renderVideo(){var e=0;recordingConfiguration.projectJson={},recordingConfiguration.projectJson.version="2.0",recordingConfiguration.projectJson.footageList=[],recordingConfiguration.projectJson.clips=[],recordingConfiguration.projectJson.totalVideoTracks=3,recordingConfiguration.projectJson.trackNames=["Screen recording","Webcam","Track 3"],recordingConfiguration.projectJson.canvasWidth=384,recordingConfiguration.projectJson.canvasHeight=216,recordingConfiguration.projectJson.resolution=recordingConfiguration.resolution,recordingConfiguration.webcamPosition&&(recordingConfiguration.projectJson.webcamPosition=recordingConfiguration.webcamPosition),recordingConfiguration.webcamShape&&(recordingConfiguration.projectJson.webcamShape=recordingConfiguration.webcamShape),recordingConfiguration.webcamSize&&(recordingConfiguration.projectJson.webcamSize=recordingConfiguration.webcamSize);for(var o=0,n=0;n<recordingConfiguration.uploadedTakes.length;n++){var t=recordingConfiguration.uploadedTakes[n];o=0==n?t.duration:Math.min(t.duration,o)}recordingConfiguration.sourceConfig||(recordingConfiguration.sourceConfig={}),(!recordingConfiguration.sourceConfig.webcam||recordingConfiguration.sourceConfig.webcam.width<=0||recordingConfiguration.sourceConfig.webcam.height<=0)&&(recordingConfiguration.sourceConfig.webcam={width:288,height:216}),(!recordingConfiguration.sourceConfig.screen||recordingConfiguration.sourceConfig.screen.width<=0||recordingConfiguration.sourceConfig.screen.height<=0)&&(recordingConfiguration.sourceConfig.screen={width:384,height:216});for(var n=0;n<recordingConfiguration.uploadedTakes.length;n++){console.info("renderVideo uploaded files",{file:recordingConfiguration.uploadedTakes[n]});var t=recordingConfiguration.uploadedTakes[n];recordingConfiguration.projectJson.footageList.push(t.id);var r={};r.id=t.id,r.duration=t.duration,r.containsVideo=1!=t.type||recordingConfiguration.webCam,r.containsAudio=1==t.type&&recordingConfiguration.audio;var i={};if(i.xpos=0,1==t.type&&recordingConfiguration.uploadedTakes.length>1){var a=getWebcamLayout(recordingConfiguration.sourceConfig.webcam,recordingConfiguration.sourceConfig.screen,recordingConfiguration.webcamPosition,recordingConfiguration.webcamSize);i.width=a.width,i.height=a.height,i.xpos=a.x,i.ypos=a.y}else{var s;s=1==t.type?recordingConfiguration.sourceConfig.webcam:recordingConfiguration.sourceConfig.screen;var c=fitCenterLayout(s,{width:384,height:216});i.width=c.width,i.height=c.height,i.xpos=c.x,i.ypos=c.y,recordingConfiguration.projectJson.crop={x:c.x,y:c.y,w:c.width,h:c.height}}if(0==t.type)r.type="screenrecord";else{r.type="webcam";var d=void 0==recordingConfiguration.isMirrorWebCam||recordingConfiguration.isMirrorWebCam;r.isSourceFlipNotNeeded=d}i.opacity=1,i.volume=1,i.fadein=0,i.fadeout=0;var g={};g.position=1e-4,g.id=e++,g.start=0,g.end=o,g.track=1==t.type?2:1,g.footage=r,g.deleted=!1,g.properties=i,recordingConfiguration.projectJson.clips.push(g)}console.info("renderVideo dummyjson",{projectJSON:recordingConfiguration.projectJson}),recordingConfiguration.workflowPopId?messageContentScripts("preprocess_complete",{workflowPopId:recordingConfiguration.workflowPopId,projectJson:recordingConfiguration.projectJson}):messageContentScripts("preprocess_complete",recordingConfiguration.projectJson),messageContentScripts("configuration",recordingConfiguration),local&&APIClient.mergeAndRender(recordingConfiguration.assetId,recordingConfiguration.projectJson,function(e){console.info("renderVideo merged video",{response:JSON.stringify(e)})},function(e){console.error("renderVideo mergeandrender error",{error:JSON.stringify(e)})}),console.info("mergeAndRender called"),onCompleteHandler()}function fitCenterLayout(e,o){var n=CommonUtils.maximizeSize(e,o);return{x:(o.width-n.width)/2,y:(o.height-n.height)/2,width:n.width,height:n.height}}function getWebcamLayout(e,o,n,t){var r=fitCenterLayout(o,{width:384,height:216}),i=r.y+r.height,a=r.x+r.width,s=r.y,c=r.x,d=getWebcamSize(t,e,r);return void 0==n&&(n="bottom-left"),"bottom-left"==n?{x:c,y:i-d.height,width:d.width+2,height:d.height+2}:"bottom-right"==n?{x:a-d.width,y:i-d.height,width:d.width+2,height:d.height+2}:"top-right"==n?{x:a-d.width,y:s,width:d.width+2,height:d.height+2}:"top-left"==n?{x:c,y:s,width:d.width+2,height:d.height+2}:void 0}function getWebcamSize(e,o,n){var t;void 0==e&&(e="large"),"large"==e&&(t=.375),"medium"==e&&(t=.305),"small"==e&&(t=.241);var r={width:n.width,height:n.height*t};return CommonUtils.maximizeSize(o,r)}function completeWithError(e){console.error("completeWithError completing with error",{error:JSON.stringify(e)}),onCompleteHandler(),e.blameUser&&showAlertPage(e),timer&&clearTimeout(timer),setBadgeText(""),screenStream&&(screenStream=null),recordingConfiguration.error=!0,-1==constants.failedUploadErrors.indexOf(e.type)&&chrome.storage.local.remove(["incomplete_upload_asset","recording_not_complete","pending_actions"]),messageContentScripts("error_recording",e)}function showAlertPage(e){"UNKNOWN_SCREEN_ERROR"==e.name&&APIClient.logData(recordingConfiguration.assetId,"screenerror","Chrome Update Error - "+e.name),chrome.tabs.query({active:!0,currentWindow:!0},function(o){var n;o.length>0&&(n=o[0]),n?chrome.tabs.sendMessage(n.id,{show_alert:e.code},void 0,function(o){o?console.info("showAlertPage already injected"):chrome.tabs.create({url:chrome.extension.getURL("html/injected/alert.html?type="+e.code)})}):chrome.tabs.create({url:chrome.extension.getURL("html/injected/alert.html?type="+e.code)})})}function onCompleteHandler(){clearTimeout(autoFinishTimeout),recordingConfiguration.completed=!0,console.info("onCompleteHandler called"),isRecordingInitiated=!1,pendingUpdate&&(pendingUpdate=!1,chrome.runtime.reload()),isLessonly||chrome.storage.sync.remove(["wizDigest"])}function getMaxResolution(){switch(recordingConfiguration.resolution){case"1080":return{width:1920,height:1080};case"720":return{width:1280,height:720};case"480":return{width:896,height:504};case"360":return{width:640,height:360}}}function s3Logger(e){console.info("s3Logger",{s3logs:e})}function s3ErrorHandler(e){"UPLOADING_SLOWLY"==e.name||"NETWORK_REQUEST_FAILING"==e.name?APIClient.setErrorActivity(recordingConfiguration.assetId,e):"NOTHING_RECORDED"==e.name||"NO_DATA_AVAILABLE"==e.name||recordingConfiguration.error||(APIClient.setErrorActivity(recordingConfiguration.assetId,e),["MULTIPART_COMPLETE_ERROR","MULTIPART_CREATE_ERROR","MULTIPART_UPLOAD_ERROR","INVALID_FEDERATED_TOKEN","INVALID_DATE_ERROR"].includes(e.name)&&(!["INVALID_FEDERATED_TOKEN","MULTIPART_CREATE_ERROR","INVALID_DATE_ERROR"].includes(e.name)||void 0!=recordingConfiguration.stopped&&recordingConfiguration.stopped?(chrome.storage.local.get("hippo_errors",function(e){var o={};e&&e.hippo_errors&&(o=e.hippo_errors,o[constants.localErrors.UPLOAD_FAILED]?o[constants.localErrors.UPLOAD_FAILED]+=1/fileUploadManager.getUploaders().length:o[constants.localErrors.UPLOAD_FAILED]=1/fileUploadManager.getUploaders().length),chrome.storage.local.set({hippo_errors:o}),uploadErrorCount+=1/fileUploadManager.getUploaders().length}),uploadError=!0):(recordingConfiguration.error=!0,e.message=constants.errorMessage[e.name],stopBackgroundRecording(e),completeWithError(e))))}function showNotification(e){chrome.notifications.create("hippo-notification",{type:"basic",title:"Hippo Video",iconUrl:"/images/injected/logo.png",message:e})}function showUpgradeNotification(e){chrome.notifications.create("upgrade-notification",{type:"basic",title:"Hippo Video",iconUrl:"/images/injected/logo.png",buttons:[{title:"click here to upgrade"}],message:e})}function getSafeRecordingConfiguration(e){return{webCam:e.webCam,audio:e.audio,screenRecord:e.screenRecord,resolution:e.resolution,webcamPosition:e.webcamPosition,webcamShape:e.webcamShape,webcamSize:e.webcamSize,sourceConfig:e.sourceConfig,startWebCamTime:e.startWebCamTime,startScreenTime:e.startScreenTime,isMirrorWebCam:e.isMirrorWebCam}}function checkChromeRuntimeError(e){try{chrome.runtime.lastError&&console.silent("checkChromeRuntimeError ",{context:e,error:chrome.runtime.lastError.message})}catch(e){}}function clearCredentials(e){chrome.storage.sync.remove(["wizUserEmail","wizAuthToken","wizDigest"],function(){console.info("cleared all credentials"),e()})}function copyToClipBoard(e){var o=document.createElement("textarea");o.textContent=e;var n=document.getElementsByTagName("body")[0];n.appendChild(o),o.select(),document.execCommand("copy"),n.removeChild(o)}function setErrorActivityAfterReload(e,o,n){setActionAfterReload({type:"setErrorActivity",assetId:e,errorState:o},n)}function setActionAfterReload(e,o){chrome.storage.local.get("pending_actions",function(n){var t=[];void 0!=n.pending_actions&&(t=n.pending_actions),t.push(e),chrome.storage.local.set({pending_actions:t},o)})}function pendingActionsPresent(e){chrome.storage.local.get(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(o){e(void 0!=o.pending_actions&&o.pending_actions.length>0)})}function executePendingActions(){chrome.storage.local.get(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(e){if(void 0!=e.pending_actions&&e.pending_actions.length>0){var o=e.pending_actions;for(var n in o){var t=o[n];"setErrorActivity"!=t.type||t.isErrorActivitySet?"retryVideoUpload"!=t.type||t.isErrorActivitySet||(fileUploadManager?(console.info("executePendingActions showing the user upload status page",{assetId:t.assetId}),console.info("executePendingActions showing the user upload status page",{assetId:t.assetId})):(uploadObject=t,IDBUtils.getTotalCount(function(e){console.info("executePendingActions total count",{count:e}),e>0?(console.info("executePendingActions setting as user abort",{assetId:uploadObject.assetId}),APIClient.setErrorActivity(uploadObject.assetId,CommonUtils.getError("USER_ABORT"),markErrorActivitySentForAsset),recordingConfiguration=uploadObject.recordingConfiguration,fileUploadManager=new FileUploadManager,uploadObject.screenId&&uploadObject.webcamId?(webcamUploader=new S3Uploader("webcam",uploadObject.recordingConfiguration.webcam.id,uploadObject.recordingConfiguration.webcam.bucket,uploadObject.recordingConfiguration.webcam.key,"private",6e4,s3Logger,void 0,uploadObject.assetId,useAccelerate),screenUploader=new S3Uploader("screen",uploadObject.screenId,uploadObject.recordingConfiguration.screen.bucket,uploadObject.recordingConfiguration.screen.key,"private",6e4,s3Logger,void 0,uploadObject.assetId,useAccelerate),screenUploader.uploadStatus=constants.uploadStatus.FAILED,webcamUploader.uploadStatus=constants.uploadStatus.FAILED,fileUploadManager.addUploader(webcamUploader),fileUploadManager.addUploader(screenUploader)):uploadObject.screenId?(screenUploader=new S3Uploader("screen",uploadObject.screenId,uploadObject.recordingConfiguration.screen.bucket,uploadObject.recordingConfiguration.screen.key,"private",6e4,s3Logger,void 0,uploadObject.assetId,useAccelerate),screenUploader.uploadStatus=constants.uploadStatus.FAILED,fileUploadManager.addUploader(screenUploader)):uploadObject.webcamId&&(webcamUploader=new S3Uploader("webcam",uploadObject.recordingConfiguration.webcam.id,uploadObject.recordingConfiguration.webcam.bucket,uploadObject.recordingConfiguration.webcam.key,"private",6e4,s3Logger,void 0,uploadObject.assetId,useAccelerate),webcamUploader.uploadStatus=constants.uploadStatus.FAILED,fileUploadManager.addUploader(webcamUploader))):(console.error("executePendingActions setting as recording failed",{assetId:uploadObject.assetId}),APIClient.setErrorActivity(uploadObject.assetId,CommonUtils.getError("RECORDING_FAILED"),markErrorActivitySentForAsset))}))):(console.info("executePendingActions type setErrorActivity",{assetId:t.assetId}),APIClient.setErrorActivity(t.assetId,t.errorState,markErrorActivitySentForAsset),updatedError=!0,console.info("executePendingActions type setErrorActivity",{assetId:t.assetId}))}}})}function markErrorActivitySentForAsset(e,o){chrome.storage.local.get("pending_actions",function(n){for(var t=n.pending_actions,r=0;r<t.length;r++)e==t[r].assetId&&1==o.status&&(t[r].isErrorActivitySet=!0);chrome.storage.local.set({pending_actions:t})})}function showUploadStatusPage(){var e=chrome.extension.getURL("html/extension/uploadStatus.html");chrome.tabs.create({url:e})}function showUploadStatusOverlay(e){e&&e.tab&&e.tab.id&&(console.warn("showing upload progress overlay"),messageContentScripts("showUploadProgressOverlay",{tabId:e.tab.id,windowId:e.tab.windowId}),messageContentScripts("forceDestroyWFP",{tabId:e.tab.id,windowId:e.tab.windowId}))}function closeUploadStatusOverlay(e){e&&e.tab&&e.tab.id&&messageContentScripts("removeUploadProgressOverlay",{tabId:e.tab.id,windowId:e.tab.windowId})}function retryUpload(){void 0!=fileUploadManager&&fileUploadManager.checkAndRetryUploads(),chrome.storage.local.remove(["recording_not_complete"])}function cancelUpload(){void 0===fileUploadManager?(console.error("cancelUpload: anomaly case"),chrome.storage.local.remove(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(){chrome.runtime.reload()})):(fileUploadManager.checkAndCancelUploads(),IDBUtils.getTotalCount(function(e){e>0?(console.info("cancelUpload: setting as user abort",{count:e}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("USER_ABORT"))):(console.info("cancelUpload: setting as recording failed",{count:e}),APIClient.setErrorActivity(recordingConfiguration.assetId,CommonUtils.getError("RECORDING_FAILED")))}))}function reloadExtension(){messageContentScripts("removeUploadProgressOverlay");var e=CommonUtils.getError("USER_ABORT");IDBUtils.getTotalCount(function(o){o<=0&&(e=CommonUtils.getError("RECORDING_FAILED")),chrome.storage.local.get(["incomplete_upload_asset"],function(o){o.incomplete_upload_asset?"USER_ABORT"==e.name?APIClient.setErrorActivity(recordingConfiguration.assetId,e,function(){setErrorActivityAfterReload(o.incomplete_upload_asset,e,function(){chrome.storage.local.remove(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(){chrome.runtime.reload()})})}):setErrorActivityAfterReload(o.incomplete_upload_asset,e,function(){chrome.storage.local.remove(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(){chrome.runtime.reload()})}):chrome.storage.local.remove(["pending_actions","recording_not_complete","incomplete_upload_asset"],function(){chrome.runtime.reload()})})})}function showUploadWarningOverlay(e){e&&e.tab&&e.tab.id&&(messageContentScripts("showUploadWarningOverlay",{tabId:e.tab.id,windowId:e.tab.windowId}),messageContentScripts("forceDestroyWFP",{tabId:e.tab.id,windowId:e.tab.windowId}))}function isSlowNetwork(){return navigator&&navigator.connection&&navigator.connection.downlink<1}function setUserPreferences(e){var o={screenRecord:e.screenRecord,webCam:!!e.pseudoWebcam||e.webCam,audio:e.audio},n={aspectRatio:e.aspectRatio,audioSource:e.audioSource,highlights:e.highlights,resolution:e.resolution,systemAudio:e.systemAudio,videoBitRate:e.videoBitRate,webcamBitRate:e.webcamBitRate,webcamSource:e.webcamSource,webcamPosition:e.webcamPosition,webcamShape:e.webcamShape,webcamSize:e.webcamSize||e.webCamSize,webcamVisible:!e.separateLayer,fullDesktop:e.fullDesktop,isDefaultFullDesktop:e.isDefaultFullDesktop,isMirrorWebCam:void 0==e.isMirrorWebCam||e.isMirrorWebCam,lowerThird:e.lowerThird};updateAspectRatio(n,o),updateRecordingPreferences(n,o)}function updateRecordingPreferences(e,o){chrome.storage.sync.get(["userPreferences"],function(o){var n=o.userPreferences;void 0!=n.highlightState&&(e.highlightState=n.highlightState),void 0==n&&(n={}),"circle"==e.webcamShape&&(e.aspectRatio=n.aspectRatio),chrome.storage.sync.set({userPreferences:e},function(){})}),chrome.storage.sync.set({recordingDefaults:o},function(){})}function updateUserPreferences(e){chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(o){var n=o.userPreferences;void 0==n&&(n={}),n.resolution=e.resolution,chrome.storage.sync.set({userPreferences:n},function(){})})}function getUploadStatus(e){var o={status:constants.uploadStatus.WAITING};return void 0!=recordingConfiguration&&(o.assetId=recordingConfiguration.assetId),fileUploadManager&&(o={isRecording:isRecording,progress:fileUploadManager.getUploadProgress(),status:fileUploadManager.getUploadStatus()}),void 0!=recordingConfiguration&&(o.showWebcamTour=recordingConfiguration.showWebcamTour||!1),chrome.storage.local.get("recording_not_complete",function(n){if(o.recordingError=void 0!=n.recording_not_complete,uploadObject){var t=[];uploadObject.screenId&&t.push(uploadObject.screenId),uploadObject.webcamId&&t.push(uploadObject.webcamId),IDBUtils.isKeysPresent(t,function(n,t){o.canRetry=n,o.sourceAvailable=t,e(o)})}else e(o)}),!0}var local="cijidiollmnkegoghpfobabpecdkeiah"!==chrome.runtime.id,server=local?"http://localhost:3000":"https://www.hippovideo.io",isLessonly=-1!=chrome.runtime.getManifest().name.toLowerCase().indexOf("lessonly"),pendingUpdate=!1,sentCount,initiatorUrl,videoShareUrl,videoThumbnailUrl,videoEmbedUrl,fileUploadManager,askAccountConfirmation=!1,is_guest_user=!1,previewIframeData,markupToolEnabled=!0,useAccelerate=!0,highlightsEvents={hvColorChoose:0,hvCloseHighlight:0,hvOpenHighlight:0,hvClearScreen:0,hvEraser:0,hvPen:0,hvFocusArea:0,hvCursor:0,allow:!0,asset_id:null,current_action:null,pause_play:null,hvCursorAnimation:0,hvWebCam_show:null,hvWebCam_hide:null,hvWebCam:0},uploadObject,initiatorTabId,videoToBeAttached,googleAccessTabId,gmailTabId,googleAccessResponse,dataStreamer,dynamicIntegrationsFiles={},allPorts=[],videoAspectRatio,videoFrameRate=24,openSalesFlowInGmail={},videoToken=void 0,uploadError=!1,uploadErrorCount=0,recordedVideoOpened=!1,coundownInitialTime=0,coundownPauseTime=0,isPlaying=!1,webcamQuality={},lightingFeedback=void 0,genericIntegWidgets=void 0,changeRedirectUrl=!1,fallbackDynamicIntegUrls={"google-slides":{host:["docs.google.com"],href:["docs.google.com/presentation"]},"google-classroom":{host:["classroom.google.com"]},"google-document":{host:["docs.google.com"],href:["docs.google.com/document"]},d2l:{href:["brightspace","elearningontario.ca","dsbntest.desire2learn.com"]},gmail:{host:["mail.google.com"],href:["mail.google.com/mail"]},"google-drive":{host:["drive.google.com"]},slack:{host:[".slack.com"]},trello:{host:["trello.com"]},outreach:{host:[".outreach.io"]},linkedin:{host:[".linkedin.com"]},jira:{host:[".atlassian.net"]},freshsales:{host:["freshsales.io"]},freshchat:{host:["freshchat.com"]},googlechat:{host:["mail.google.com"],href:["mail.google.com/chat"]},"mailshake-dynamic":{host:["mailshake.com"]},"salesforce-dynamic":{host:["force.com"]},"pardot-dynamic":{host:["pardot.com"]},"hubspot-dynamic":{host:["hubspot.com"]},"pipedrive-dynamic":{host:["pipedrive.com"]},"phoneburner-dynamic":{host:["phoneburner.com"]},"outlook-dynamic":{host:["outlook.live.com","outlook.office.com","outlook.office365.com"]},"intercom-dynamic":{host:["intercom.com"]},"dynamics-365-dynamic":{host:[".dynamics.com"]}},chromeLocalStorageConstants={isShortenUrlEnabled:"isShortenUrlEnabled"},genericIntegsForMessageHandling=["get_utm_token","intercom_dynamic","linkedin_dynamic","trello_dynamic","google_classroom_dynamic","pipedrive_dynamic","jira_dynamic","phoneburner_dynamic","outreach_dynamic","outlook_dynamic","hubspot_dynamic","freshchat_dynamic","salesloft_dynamic","freshsales_dynamic","apollo_dynamic","workable_dynamic","outplay_dynamic","zoho_crm_dynamic","datazoic_dynamic","saleshandy_dynamic","groove_dynamic"];chrome.browserAction.setIcon({path:"/images/extension/main-icon.png"}),chrome.browserAction.setBadgeText({text:""});var os;chrome.runtime.getPlatformInfo(function(e){os=e.os}),chrome.gcm.onMessage.addListener(function(e){var o=e.data;if("true"==o.is_event)"1"==o.event_type?updateLocalStorageDynamicIntegConfig(o.event_data):"2"==o.event_type&&updateLocalStorageDynamicIntegConfig(void 0,o.event_data);else{setBadgeText(e.data.notification_count,"#30a7ce");var n=e.data;n.notification_type&&parseInt(n.type_count)>0&&messageEmbedScripts("showLiveNotifications",{notification:n})}}),chrome.storage.local.get("hippo_errors",function(e){var o={};e&&e.hippo_errors&&(o=e.hippo_errors,o[constants.localErrors.UPLOAD_FAILED]&&(uploadErrorCount=o[constants.localErrors.UPLOAD_FAILED]))}),isLessonly?chrome.browserAction.disable():chrome.runtime.setUninstallURL(server+"/chrome_feedback",function(){console.warn("Extension restarted")}),chrome.windows.onRemoved.addListener(function(e){}),pendingActionsPresent(function(e){e&&APIClient.isUserSignedIn(function(e){parseAuthResponse(e),executePendingActions()},function(){})}),IDBUtils.init(),chrome.runtime.onMessageExternal.addListener(function(e,o,n){if(e.getVideoUploadingStatus&&getUploadStatus(n),"embedded_preview"==e.ping&&(insertContentScripts(o.tab.id,o.frameId),n({success:!0})),1==e.updatedUserPreferences&&updateUserPreferences({resolution:e.resolution}),"hippo wiz"==e.ping)if(isRecordingInitiated)n({success:!1,isRecordingInitiated:!0,extensionId:chrome.runtime.id});else{insertContentScripts(o.tab.id,e.embeddedFrame?o.frameId:void 0);try{var t,r;navigator.mediaDevices.enumerateDevices().then(function(e){chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(o){void 0==o.userPreferences&&void 0==o.recordingDefaults?(t=!1,r=!1):(t=$.extend({},o.userPreferences,o.recordingDefaults),r=o.recordingDefaults),n({success:!0,devices:e,os:os,isSlowNetwork:isSlowNetwork(),userPreferencesSaved:t,extensionId:chrome.runtime.id}),updateAspectRatio(t,r)})}).catch(function(e){console.error("error enumerating Devices",{error:e}),chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(e){void 0==e.userPreferences&&void 0==e.recordingDefaults?(t=!1,r=!1):(t=$.extend({},e.userPreferences,e.recordingDefaults),r=e.recordingDefaults),n({success:!1,os:os,isSlowNetwork:isSlowNetwork(),userPreferencesSaved:t,extensionId:chrome.runtime.id}),updateAspectRatio(t,r)})})}catch(e){console.error("error in enumerateDevices",{error:e})}}if("cancel_recording"==e.ping&&cancelBackgroundRecording(),"webcam_quality"==e.ping&&n({status:!0,data:webcamQuality}),"reload_extension"==e.ping&&(reloadExtension(),n({status:!0})),"retry_upload"==e.ping&&(retryUpload(),n({status:!0})),"lighting_feedback"==e.ping&&n({status:!0,data:lightingFeedback}),"retake_recording"==e.ping&&retakeRecording(),e.addLinkFromPopup&&messageEmbedScripts("add-share-link-to-page",{shareUrl:e.url,thumbnailUrl:e.thumbnailUrl,embedUrl:e.embedLink,initiator:e.initiator}),e.closePreviewPopup&&messageEmbedScripts("close-preview-popup",{initiator:e.initiator}),e.getDynamicIntegInitiator&&(n({tabUrl:initiatorUrl,initiator:recordingConfiguration.initiator,initiatorThreadId:recordingConfiguration.initiatorThreadId}),initiatorUrl=void 0),e.videoShareUrl&&("gmail"==e.recordInitiator?e.initiatorGmail&&"add-on"==e.initiatorGmail&&attachVideoInGmail(e,"reply"):"slack"==e.recordInitiator?(chrome.tabs.update(popupTabId,{selected:!0}),messageEmbedScripts(e.recordInitiator+"-insert-link",{shareUrl:e.shareUrl,thumbnailUrl:e.thumbnailUrl,embedUrl:e.embedLink,videoTitle:e.videoTitle})):(videoThumbnailUrl=e.thumbnail_url,videoShareUrl=e.shareUrl,videoEmbedUrl=e.embedLink,chrome.tabs.create({url:e.url}))),e.openSalesFlowInGmail&&chrome.tabs.create({url:"https://www.gmail.com"},function(e){openSalesFlowInGmail[e.id]=!0}),e.dynamicIntegConfig&&e.config&&updateLocalStorageDynamicIntegConfig(e.config,e.integUrls),void 0!==e.authToken||void 0!==e.digest){if(void 0!==e.authToken){var i={wizAuthToken:e.authToken,wizUserEmail:e.userEmail,wizPlanName:e.planName,dynamicIntegConfig:e.dynamicIntegConfig,wizUserId:e.userId};isLessonly||(i.wizDigest=""),chrome.storage.sync.set(i,function(){var o=[],n=(new Date).toISOString(),t=chrome.runtime.getManifest().version+" : "+n+" : onMessageExternal-"+e.userEmail+"-"+e.authToken;o.push({authoringAssetId:"",stackTrace:t}),e.dynamicIntegConfig&&updateLocalStorageDynamicIntegConfig(e.dynamicIntegConfig),e.placeIconInGmailToolbox&&updateGmailIconPosition(e.placeIconInGmailToolbox),e.genericIntegWidgets&&(genericIntegWidgets=e.genericIntegWidgets),LoggingUtils.userEmailId=e.userEmail,LoggingUtils.userId=e.userId,console.info("signin details",{authtoken:e.authToken,userEmail:e.userEmail,planName:e.planName,userId:e.userId,details:o})})}void 0!==e.digest&&chrome.storage.sync.set({wizDigest:e.digest},function(){console.info("signin details",{digest:e.digest})})}if(1==e.userNowWantsToRecord){var a=chrome.extension.getURL("html/injected/onboard.html");chrome.tabs.create({url:a})}return 1==e.canUserAccess&&chrome.storage.sync.get(null,function(e){n(void 0!=e.allurlaccess&&1==e.allurlaccess)}),1==e.getVideos&&(!recordingConfiguration||e.assetId&&e.assetId!=recordingConfiguration.assetId?n("changed"):0!=recordingConfiguration.error&&void 0!=recordingConfiguration.error?n({recordingConfiguration:recordingConfiguration,error:recordingConfiguration.error,ask_confirm:askAccountConfirmation}):recordingConfiguration.allDataAvailable?(sentCount=0,uploadObject.screenId&&(sentCount++,CommonUtils.sendFromLocalVideo("screendata",uploadObject.screenId,262144,o.tab.id,function(){sentCount--},e.fromEmbed)),uploadObject.webcamId&&(sentCount++,CommonUtils.sendFromLocalVideo("webcamdata",uploadObject.webcamId,262144,o.tab.id,function(){sentCount--},e.fromEmbed)),n({recordingConfiguration:recordingConfiguration,proceeded:!0,ask_confirm:askAccountConfirmation})):n("wait")),1==e.sentAll&&n(0==sentCount?"yes":"no"),1==e.projectJson&&n({projectJson:recordingConfiguration.projectJson}),e.embedWidgetDigest&&(console.info("embed widget token",{embedDigest:e.embedWidgetDigest}),chrome.storage.sync.set({wizDigest:e.embedWidgetDigest},function(){console.info("saved digest",{embedDigest:e.embedWidgetDigest}),n("embedWidgetDigest saved")}),insertContentScripts(o.tab.id)),e.get_upload_progress&&void 0!=fileUploadManager&&n({uploadProgress:fileUploadManager.getUploadProgress()}),e.closeRequestedTab&&chrome.tabs.remove(o.tab.id),!0}),chrome.tabs.query({},function(e){for(var o=0;o<e.length;o++)insertAllSitesScript(e[o].id,isLessonly);setTimeout(function(){messageExternal("product","extension_installed")},2e3)}),chrome.runtime.onInstalled.addListener(function(e){if(signInUserAutomatically("After Install"),"install"==e.reason){var o=chrome.extension.getURL("html/injected/onboard.html");chrome.tabs.getAllInWindow(null,function(e){for(var n=chrome.runtime.id+"/related?utm_source=hubspot",t={showHubspotOnboarding:!1,tabIdToBeClosed:void 0},r=0;r<e.length;r++){var i=e[r];if(i.url.includes("mail.google.com")){chrome.tabs.executeScript(i.id,{code:"window.location.reload(true);"})}i.url.includes("/integrations/add-to-chrome")&&(t.tabIdToBeClosed=i.id),i.url.includes(n)&&(t.showHubspotOnboarding=!0)}t.showHubspotOnboarding?(chrome.tabs.create({url:server+"/integrations/hubspot-features"}),void 0!=t.tabIdToBeClosed&&chrome.tabs.remove(t.tabIdToBeClosed)):chrome.tabs.create({url:o})})}else if("update"==e.reason){var n=chrome.runtime.getManifest().version;console.info("Extension updated",{oldVersion:e.previousVersion,newVersion:n})}}),chrome.management.onDisabled.addListener(function(e){chrome.runtime.id==e.id&&clearAuthenticationData()}),chrome.management.onEnabled.addListener(function(e){chrome.runtime.id==e.id&&signInUserAutomatically("After Enabled")});var isRecordingInitiated=!1,waitingForScreenPermission=!1,chooseDesktopMediaReqId,isRecording=!1;messageRecordingStateToContentScripts();var isPaused=!1,initialTime,timer,resolutions={maxWidth:29999,maxHeight:8640},aspectRatio=1.77,audioBitsPerSecond=0,videoBitsPerSecond=0,enableTabAudio=!1,videoCodec="Default",videoMaxFrameRates="";chrome.runtime.onUpdateAvailable.addListener(function(e){isRecording?pendingUpdate=!0:chrome.runtime.reload(),console.info("Called to check if update of plugin is available")});var runtimePort,recordingConfiguration,vbgJson;chrome.runtime.onMessage.addListener(function(e,o,n){if(e.shouldIRecordNow){var t=isRecording&&recordingConfiguration.highlights&&recordingConfiguration.screenRecord;n({response:showCameraOnOtherTabs&&isRecording,showMarkupTools:t,recordingConfiguration:recordingConfiguration,tabId:o.tab.id})}else if(e.webcamSource){var r=void 0==recordingConfiguration.aspectRatio?getAspectRatio():recordingConfiguration.aspectRatio,i=void 0==recordingConfiguration.isMirrorWebCam||recordingConfiguration.isMirrorWebCam;n({webcamSource:recordingConfiguration.webcamSource,aspectRatio:r,isMirrorWebCam:i})}else{if(e.getUploadStatus)return getUploadStatus(n),!0;if(e.retryUpload)retryUpload();else if(e.cancelUpload)cancelUpload();else if(e.openRecordedVideo)recordedVideoOpened||e.isGuestUser||!e.isFromExtensionPage||(recordedVideoOpened=!0,chrome.tabs.create({url:server+"/video/view/"+recordingConfiguration.assetId},function(e){insertContentScripts(e.id)})),messageContentScripts("removeUploadProgressOverlay");else if(e.uploadWarningAck)chrome.storage.local.get("hippo_errors",function(e){var o={};e&&e.hippo_errors&&(o=e.hippo_errors,o[constants.localErrors.UPLOAD_FAILED]=0),chrome.storage.local.set({hippo_errors:o}),uploadErrorCount=0}),messageContentScripts("removeUploadWarningOverlay");else if(e.closeUploadOverlay)closeUploadStatusOverlay(o);else if(e.reloadExtension)reloadExtension();else if(e.getAspectRatioAndFrameRate){var r=videoAspectRatio;recordingConfiguration&&void 0!=recordingConfiguration.aspectRatio&&"circle"!=recordingConfiguration.webcamShape&&(r=recordingConfiguration.aspectRatio);var a={aspectRatio:r,frameRate:videoFrameRate};recordingConfiguration&&(a.webcamSource=recordingConfiguration.webcamSource,a.audioSource=recordingConfiguration.audioSource,a.isMirrorWebCam=void 0==recordingConfiguration.isMirrorWebCam||recordingConfiguration.isMirrorWebCam),n(a)}else if(e.getDownloadURL){var s=new DataStreamer;s.downloadBlobs(fileUploadManager,function(e){chrome.runtime.sendMessage({msg:"downloadUrl",data:e}),s=void 0}),n({status:"ok"})}else if(e.togglePauseResume){var c=togglePauseResume();n({status:c})}else if(e.stopBackgroundRecording)finishBackgroundRecording();else if(e.getRecordingInfo)n({isPaused:isPaused,recordingConfiguration:recordingConfiguration});else if(e.webcamPreviewDoubleClicked)recordingConfiguration.isWebcamPreviewMaximized=!0,messageContentScripts("webcamPreviewDoubleClicked",{tabId:o.tab.id,windowId:o.tab.windowId});else if(e.showVBG)chrome.storage.sync.get(["wizUserEmail","wizAuthToken"],function(o){vbgJson={assetId:e.assetId,json:e.json,extnId:chrome.runtime.id,popId:e.popId,popupDetails:e.popupDetails}}),chrome.tabs.executeScript({file:"js/dynamicintegration/hv_workflow/vbg_ctx_fix.js"},function(){}),chrome.tabs.executeScript({file:"js/dynamicintegration/hv_workflow/workflow_vbg_bundle.js"},function(){console.log("INJECTED AND EXECUTED VBG BUNDLE")});else if(e.readyToMount)n({msg:"setVBJSON",data:vbgJson});else if(e.webcamQuality)webcamQuality=e.data;else if(e.lightingFeedback)lightingFeedback=e.data;else if(e.askWebcamPermission)messageContentScripts("askWebcamPermission",{is_new_recording_screen:"new_recording_screen"==e.data});else if(e.vbgApplied)messageContentScripts("vbgApplied",{workflowPopId:e.popId,
vbgThumbURL:e.vbgThumbURL,tabId:e.popupDetails.tabId,windowId:e.popupDetails.windowId,serviceName:e.popupDetails.serviceName});else if(e.closeVBGSidebar)messageContentScripts("closeVBGSidebar",{workflowPopId:e.popId,tabId:e.popupDetails.tabId,windowId:e.popupDetails.windowId,serviceName:e.popupDetails.serviceName});else{if(e.vbg_extn_fetch_videos)return APIClient.fetchVideosExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_masked_images)return APIClient.getMaskedImagesApiExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_apply_vbg)return APIClient.applyVirtualBgExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_revert_vbg)return APIClient.revertVirtualBgExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_search_library)return APIClient.searchLibraryExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_status_poller)return APIClient.statusPollerExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;if(e.vbg_extn_manage_tags)return APIClient.getManageTagsApiExtnVBG(e.params,function(e){n({status:"true",data:e})},function(e){n({status:"false",data:e})}),!0;n({farewell:"goodbye",tabId:o.tab.id})}}}),Array.prototype.remove=function(){for(var e,o,n=arguments,t=n.length;t&&this.length;)for(e=n[--t];-1!==(o=this.indexOf(e));)this.splice(o,1);return this};var allTabs=[],showCameraOnOtherTabs=!1;chrome.runtime.onConnect.addListener(function(e){runtimePort=e;var o;for(o=0;o<allPorts.length&&allPorts[o]!=e;o++);for(o==allPorts.length?allPorts.push(e):console.error("fatal, port already added"),o=0;o<allPorts.length-1;o++)try{if(!(allPorts[o].sender.frameId!=e.sender.frameId||allPorts[o].sender.url!=e.sender.url||allPorts[o].name!=e.name||allPorts[o].sender.tab&&e.sender.tab&&allPorts[o].sender.tab.id!=e.sender.tab.id)){allPorts.splice(o,1);break}}catch(e){}runtimePort.onDisconnect.addListener(function(e){for(var o=0;o<allPorts.length;o++)if(0!=e.sender.frameId){if(allPorts[o].sender.frameId==e.sender.frameId){allPorts.splice(o,1);break}}else if(allPorts[o].sender.tab.id==e.sender.tab.id){allPorts.splice(o,1);break}chrome.storage.sync.get(["dynamicIntegConfigurations"],function(o){if(recordingConfiguration&&("lessonly"==recordingConfiguration.initiator||"generic_embed"==recordingConfiguration.initiator||"freshdesk_embed_form"==recordingConfiguration.initiator||"zendesk_embed_form"==recordingConfiguration.initiator)){var n=!!(o&&o.dynamicIntegConfigurations&&o.dynamicIntegConfigurations.hasOwnProperty(recordingConfiguration.initiator));if(recordingConfiguration&&(constants.recorderApiTypes.includes(recordingConfiguration.initiator)||n))try{if(initiatorTabId==e.sender.tab.id&&"mycontentscript"==e.name&&isRecording){var t={videoToken:videoToken,assetId:recordingConfiguration.assetId};APIClient.sendWebhookEvent("record_aborted",t),cancelBackgroundRecording()}}catch(e){console.info("lessonly_stop_recording_error",{error:e})}}}),console.silent("total ports",{ports:allPorts.length})}),runtimePort.onMessage.addListener(function(e,o){if(e&&e.messageFromContentScript1234){if(e.recordinguuid&&(LoggingUtils.recordinguuid=e.recordinguuid,console.info(e.uuidfrom)),e.initializeTimer&&(coundownInitialTime=Date.now(),coundownPauseTime=0,isPlaying=!0),e.updateTimer&&(isPlaying=e.hvPlay,e.hvPlay&&coundownPauseTime>0?(coundownPauseTime=Date.now()-coundownPauseTime,coundownInitialTime+=coundownPauseTime,coundownPauseTime=0):coundownPauseTime=Date.now()),e.resetTimer&&(coundownInitialTime=coundownPauseTime=0,isPlaying=!1),e.fetchTimerAndUpdate&&isPlaying&&messageContentScripts("fetchTimerAndUpdate",{coundownInitialTime:coundownInitialTime,coundownPauseTime:coundownPauseTime,currTime:Date.now()-coundownInitialTime}),e.devOnlyDebugLog){var n="[DEV_DEBUG_LOG] "+e.data;console.info(n)}if(e.injectHvWorkflowScripts&&injectHvWorkflowScripts(e.tabId,e.serviceName),"workflow"===e.msgType)return void handleWorkflowBackgroundMessages(e);if(e.trackUserActivity)return void trackUserActivityMessages(e.actionName,e.assetId);if(e.getRecordingStatus&&messageRecordingStateToContentScripts(),e.getUserRecordingPreferences&&chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(o){updateAspectRatio(o.userPreferences,o.recordingDefaults),messageContentScripts("user_recording_preferences",{preference:o.userPreferences,payload:e.payload})}),"gmail"===e.messageType&&handleGmailBackgroundMessages(e),"salesforce"===e.messageType&&handleSalesforceBackgroundMessages(e),"mailshake"===e.messageType&&handleMailshakeBackgroundMessages(e),"dynamics-365-dynamic"==e.messageType&&handleDynamics365BackgroundMessages(e),"outreach-dynamic"==e.messageType&&handleOutreachBackgroundMessages(e),"zoho-crm-dynamic"==e.messageType&&handleZohoCrmBackgroundMessages(e),"hubspot-dynamic"==e.messageType&&handleHubspotBackgroundMessages(e),genericIntegsForMessageHandling.includes(e.messageType)&&handleGenericIntegsBackgroundMessages(e),e.requestGoogleAccess&&(gmailTabId=Number(e.tabId),chrome.tabs.create({url:e.url},function(o){googleAccessTabId=o.id,googleAccessResponse=e})),e.openUrl&&chrome.tabs.create({url:e.url}),e.injectWfPreviewPopScripts&&injectWfPreviewPopScripts(o.sender.tab.id),e.fetchVideos){"all"==e.fetchType?APIClient.fetchVideos(e.fetchType,e.offset,e.categoryId,e.fetchCategories,e.libraryType,!0,function(o){messageEmbedScripts("videoLibrary",{type:"allvideos",library:o.libraries,category_mapping:o.category_mapping,categories:o.categories,num_videos:o.num_videos,payload:e.payload,offset:e.offset,categoryId:e.cagtegoryId,libraryType:e.libraryType,customerHost:o.customer_host})},function(e){}):APIClient.fetchVideos(e.fetchType,e.offset,e.categoryId,e.fetchCategories,e.libraryType,!0,function(o){messageEmbedScripts("videoLibrary",{type:"myvideos",library:o.libraries,category_mapping:o.category_mapping,categories:o.categories,num_videos:o.num_videos,payload:e.payload,offset:e.offset,categoryId:e.cagtegoryId,libraryType:e.libraryType,customerHost:o.customer_host})},function(e){})}if(e.googleSignup&&googleSignup(),e.signout&&signout(),e.googleSignout&&googleSignout(),e.countdownComplete&&(recordingConfiguration.countdownComplete=!0,console.info("countdown completed"),console.info("calling checkAndStartRecording from message.countdownComplete"),checkAndStartRecording()),e.startCountDownGeneral&&messageContentScripts("startCountDown",recordingConfiguration),e.askToInsertVideoLink&&messageContentScripts("videoCopyLink",{url:e.copyUrl,imgUrl:e.imageUrl,integType:e.integType,embedRef:e.embedReference}),e.askToInsertLink&&messageContentScripts("copyLink",{url:e.copyUrl,embedRef:e.embedRef,linkType:e.linkType,integType:e.integType}),e.trackDynamicIntegActivity){var t=e.integType+"-"+e.actionName;APIClient.trackDynamicIntegAction(t)}if(e.changeGmailIconSettings&&APIClient.requestServer("GmailIconSettings",e.data),e.askToInsertRecordAndLibScript&&(console.silent("Inserting Record and Lib Widget Script"),insertRecordAndLibScript(o.sender.tab.id)),e.insertPreviewPopupScript&&(console.silent("Inserting Preview Iframe Script"),chrome.storage.sync.get(["wizUserEmail","wizAuthToken"],function(e){var n=e.wizUserEmail,t=e.wizAuthToken;n&&t&&/\S/.test(n)&&/\S/.test(t)&&insertPreviewPopupScript(o.sender.tab.id)})),e.askToInsertRecordLibraryScript&&(console.silent("Inserting Record Library Widget Script"),insertRecordLibraryScript(o.sender.tab.id)),e.askToInsertRecordWidgetScript&&(console.silent("Inserting Record Widget Script"),insertRecordScript(o.sender.tab.id)),e.dynamicIntegConfig&&e.config&&updateLocalStorageDynamicIntegConfig(e.config,e.integUrls),e.doBackgroundRecording){if("hippo-website"==e.config.initiator&&isRecordingInitiated)return;initiatorTabId=o.sender.tab?o.sender.tab.id:void 0,chrome.storage.local.get(["pending_actions","recording_not_complete","changeBitrate","isFreeUser","isLifeTimePlan"],function(n){changeRedirectUrl=n.isFreeUser||n.isLifeTimePlan;var t=!1;if(void 0!=n.pending_actions&&n.pending_actions.length>0){var r=n.pending_actions;for(var i in r){"retryVideoUpload"==r[i].type&&(t=!0)}}n.recording_not_complete||t||recordingConfiguration&&!recordingConfiguration.completed?(console.warn("showing abort notificaiton"),showUploadStatusOverlay(o.sender)):uploadErrorCount>1?showUploadWarningOverlay(o.sender):(1==uploadErrorCount&&chrome.notifications.create("hippo-upload-warning",{type:"basic",title:"Hippo Video",iconUrl:"/images/injected/logo.png",message:"Your previous recording upload failed. It is recommended to check your network before doing another recording."}),recordingConfiguration=e.config,recordingConfiguration.pseudoWebcam="circle"==recordingConfiguration.webcamShape&&recordingConfiguration.screenRecord&&recordingConfiguration.webCam,initiatorTabId&&!recordingConfiguration.recordingTabId&&(recordingConfiguration.recordingTabId=initiatorTabId),recordingConfiguration.videoBitRate=7e3,recordingConfiguration.webcamBitRate=7e3,n.changeBitrate&&(recordingConfiguration.videoBitRate=4e3,recordingConfiguration.webcamBitRate=4e3),7e3==recordingConfiguration.webcamBitRate&&recordingConfiguration.screenRecord?recordingConfiguration.webcamBitRate=6e3:4e3==recordingConfiguration.webcamBitRate&&recordingConfiguration.screenRecord&&(recordingConfiguration.webcamBitRate=3e3),"lessonly"==recordingConfiguration.initiator&&(recordingConfiguration.fromPopup=!0),setUserPreferences(recordingConfiguration),recordingConfiguration.aspectRatio=getAspectRatio(),chrome.tabs.query({active:!0},function(e){var o=e[0].url;o=o.substring(0,Math.min(100,o.length)),recordingConfiguration.tabURL=e[0].url}),"google-classroom"!=recordingConfiguration.initiator&&"d2l"!=recordingConfiguration.initiator&&"google-document"!=recordingConfiguration.initiator&&"gmail"!=recordingConfiguration.initiator&&"slack"!=recordingConfiguration.initiator||(initiatorUrl=e.currentUrl,videoShareUrl=void 0,videoEmbedUrl=void 0,videoThumbnailUrl=void 0),recordingConfiguration.status={webcam:"waiting",screen:"waiting"},recordingConfiguration.countdownComplete=!1,chrome.storage.sync.get(["wizPlanName","userPreferences"],function(e){e.wizPlanName;try{"generic_embed"==recordingConfiguration.initiator&&(recordingConfiguration.audio&&!recordingConfiguration.audioSource&&(recordingConfiguration.audioSource=e.userPreferences.audioSource),recordingConfiguration.webCam&&!recordingConfiguration.webcamSource&&(recordingConfiguration.webcamSource=e.userPreferences.webcamSource))}catch(e){}videoBitsPerSecond=parseInt(recordingConfiguration.videoBitRate),recordingConfiguration.fromPopup&&recordingConfiguration.tabRecording?chrome.tabs.query({active:!0,currentWindow:!0},function(e){e.length>0&&e[0]&&e[0].url&&e[0].url.startsWith("chrome://")?(recordingConfiguration=void 0,showNotification(CommonUtils.getError("TAB_CANNOT_BE_RECORDED").message)):doBackgroundRecording()}):doBackgroundRecording()})),previewIframeData=void 0})}if(e.stopBackgroundRecording&&finishBackgroundRecording(),e.cancelBackgroundRecording&&(console.info("CANCEL RECORDING FROM API: "+e.fromAPI),e.cancelScreenRequest&&void 0!=chooseDesktopMediaReqId&&(console.info("chooseDesktopMediaReqId "+chooseDesktopMediaReqId),chrome.desktopCapture.cancelChooseDesktopMedia(chooseDesktopMediaReqId),messageContentScripts("screenpopclosed")),cancelBackgroundRecording()),e.putHighlightState){if("hvPause"!=e.action&&"hvPlay"!=e.action&&("hvWebCam_show"==e.action||"hvWebCam_hide"==e.action?highlightsEvents.hvWebCam+=1:highlightsEvents[e.action]+=1,highlightsEvents.allow=!0),"hvWebCam_show"==e.action&&(highlightsEvents[e.action]=!0,highlightsEvents.hvWebCam_hide=!1),"hvWebCam_hide"==e.action&&(highlightsEvents[e.action]=!0,highlightsEvents.hvWebCam_show=!1),"hvColorChoose"!==e.action&&(highlightsEvents.current_action=e.action),"hvClearScreen"!==e.action&&"hvColorChoose"!==e.action&&"hvEraser"!==e.action&&"hvPause"!==e.action&&"hvPlay"!=e.action){messageContentScripts("highlightState",{current_action:e.action,pause_play:highlightsEvents.pause_play})}"hvCloseHighlight"!=e.action&&"hvOpenHighlight"!=e.action||chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(o){var n=o.userPreferences,t=o.recordingDefaults;void 0==n&&(n={}),n.highlightState=e.action,updateAspectRatio(n,t),chrome.storage.sync.set({userPreferences:n},function(){})})}if(e.togglePauseResume&&togglePauseResume(),e.getState){var r=!1;chrome.storage.local.get(["pending_actions","recording_not_complete","changeBitrate"],function(e){var o=!1;if(void 0!=e.pending_actions&&e.pending_actions.length>0){var n=e.pending_actions;for(var t in n){"retryVideoUpload"==n[t].type&&(o=!0)}}(e.recording_not_complete||o||recordingConfiguration&&!recordingConfiguration.completed)&&(console.warn("showing abort notificaiton"),r=!0),recordingConfiguration&&1==recordingConfiguration.showWebcamTour&&(r=!1),messageContentScripts("currentstate",{isRecordingInitiated:isRecordingInitiated,isRecording:isRecording,isPaused:isPaused,waitingForScreenPermission:waitingForScreenPermission,recordingConfiguration:recordingConfiguration,isSlowNetwork:isSlowNetwork(),showNetworkAlert:r,uploadErrorCount:uploadErrorCount})})}if(e.getShareUrl&&("google-classroom"==e.initiator?messageEmbedScripts(e.initiator+"-share-link",{shareLink:videoShareUrl,popupRef:recordingConfiguration.googleClassroomDetails.popupRef}):messageEmbedScripts(e.initiator+"-share-link",{shareLink:videoShareUrl,embedUrl:videoEmbedUrl}),videoShareUrl=void 0,videoEmbedUrl=void 0,videoThumbnailUrl=void 0),e.getGuestLink&&APIClient.getGuestLink(function(o){messageContentScripts("guest_url",{guestUrl:o.url,integType:e.integType,reference:e.reference})},function(e){console.error("Error in guest link",{error:e})}),e.checkGmailAccounts&&messageContentScripts("checkGmailAccounts",{status:!0,response:e.data.response,composeId:e.data.composeId}),e.getWebcams&&navigator.mediaDevices.enumerateDevices().then(function(e){messageContentScripts("webcamlist",{success:!0,devices:e})}).catch(function(e){messageContentScripts("webcamlist",{success:!1})}),e.imCountingDown&&(console.info("said he is counting"),recordingConfiguration.availableForCountdown=!0,recordingConfiguration.availableForCountdown&&!recordingConfiguration.showHighlightsOnboarding||(clearTimeout(forceStartTimeout),"google-slides"!=recordingConfiguration.initiator&&(forceStartTimeout=setTimeout(function(){recordingConfiguration.countdownComplete=!0,console.info("extended force starting without countdown"),checkAndStartRecording()},7e3)))),e.askToInjectDynamicIntegScript){checkAndInjectDynamicIntegScripts(e.host,e.href,o.sender.tab.id,o.sender.tab.windowId)}if(e.trackHippoVideoLinkPasting&&console.info("HippoVideoLinkPasteTracking :: "+e.copyMedium+" :: "+e.hostname+" :: "+e.pathname),e.recordConfigUpdated&&void 0!=e.recordConfiguration&&(updateAspectRatio(e.recordConfiguration,e.recordingDefaults),messageContentScripts("updated_user_preferences",{recordConfiguration:e.recordConfiguration,recordingDefaults:e.recordingDefaults})),e.askToInjectContentScript&&(console.silent("Inserting content script for embed page"),insertContentScripts(o.sender.tab.id,isLessonly)),e.authCheck&&APIClient.isUserSignedIn(function(o){authSuccess(o,e.data),parseAuthResponse(o)},function(o){authError(o,e.data)}),e.openPPTFromDrive){var i=e.data.file_id;chrome.tabs.create({url:"https://docs.google.com/presentation/d/"+i},function(e){chrome.tabs.executeScript(e.id,{code:"window.isFromHippoVideo = true;"})})}if(e.updateUTMParams){var a=e.data.token,s=e.data.utm_source;delete e.data.token,delete e.data.utm_source,APIClient.updateUTMParams(s,a,e.data,function(e){messageEmbedScripts("updateUTMParams",{status:!0,response:e})},function(e){messageEmbedScripts("updateUTMParams",{status:!1,response:e})})}if(e.searchVideos){var c="all"==e.fetchType?"allvideos":"myvideos";APIClient.searchVideoLibrary(e.searchValue,e.categoryId,e.fetchType,function(e){messageEmbedScripts("videoLibrary",{type:c,searchVideo:!0,library:e.libraries,category_mapping:e.category_mapping,categories:e.categories,num_videos:e.num_videos})},function(e){})}if(e.getHighlightState&&chrome.storage.sync.get(["userPreferences","recordingDefaults"],function(e){var o=e.userPreferences,n=e.recordingDefaults;void 0==o&&(o={}),markupToolEnabled||(highlightsEvents.current_action="hvCursor"),messageContentScripts("injectHighlight",{current_action:highlightsEvents.current_action,savedState:o.highlightState,pause_play:highlightsEvents.pause_play,hvWebCam_show:highlightsEvents.hvWebCam_show,hvWebCam_hide:highlightsEvents.hvWebCam_hide}),updateAspectRatio(o,n)}),e.faultyMicSource&&chrome.storage.sync.get(["wizUserEmail"],function(e){var o=e.wizUserEmail;console.info("[FAULTY_MIC_SOURCE]",{userEmail:o})}),e.getMarkupToolEnabled&&(console.info("GET MARKUP TOOL ENABLED : isRec = ",isRecording),recordingConfiguration.screenRecord||(markupToolEnabled=!1),recordingConfiguration.tabRecording?chrome.tabs.query({active:!0},function(e){for(var o=0;o<e.length;o++){var n=e[o];messageContentScripts("MarkupToolEnabled",{markupToolEnabled:markupToolEnabled,os:os,currentTab:n.id,isRecording:isRecording,showWebcamTour:recordingConfiguration.showWebcamTour})}}):messageContentScripts("MarkupToolEnabled",{markupToolEnabled:markupToolEnabled,os:os,isRecording:isRecording,showWebcamTour:recordingConfiguration.showWebcamTour})),e.ewMessage){var d=e.ewMessage;if("get_environment_details"==d){messageExternal("embed_widget","environment_details",{extensionAvailable:!0,extensionSupported:!0,recordingSupported:!0,delegatedRecord:!1,capabilities:{screen:!0,webcam:!0,audio:!0,systemAudio:"mac"!=os&&"linux"!=os}})}else d.embedWidgetDigest&&(console.info("embed widget token",{embedDigest:d.embedWidgetDigest}),chrome.storage.sync.set({wizDigest:d.embedWidgetDigest},function(){console.info("saved digest",{embedDigest:d.embedWidgetDigest})}))}e.setFreeUser&&(useAccelerate=!e.isFreeUser),e.injectCsAndAssWhileWebcamTour&&(recordingConfiguration.recordingTabId=e.senderInfo.tabId,injectCsAndAssWhileRecording(e.senderInfo.tabId,e.senderInfo.windowURL)),e.stopWebcamTour&&(recordingConfiguration.showWebcamTour=!1,showCameraOnOtherTabs=!0,messageContentScripts("stopWebcamTour",e.senderInfo)),e.webcamPreviewMinimized&&(recordingConfiguration.isWebcamPreviewMaximized=!1,messageContentScripts("webcamPreviewMinimized",e.senderInfo))}})});var gup=function(e,o){var n,t="[?&#]"+o+"=([^&#]*)",r=new RegExp(t),i=r.exec(e);return null!=i&&(n=i[1]),n},authSuccess=function(e,o){e.status?(useAccelerate=!e.is_free_user,o={auth:!0,plan_params:e,payload:o}):o={auth:!1,payload:o},setParametersOnAuth(e),messageEmbedScripts("authCheck",o)},setParameterInChromeLocalStorage=function(e,o){chrome.storage.sync.set({k:o})},getParameterFromChromeLocalStorage=function(e,o){chrome.storage.sync.get([e],o)},authError=function(e,o){setParametersOnAuth({status:!1}),messageEmbedScripts("authCheck",{auth:!1,payload:o})},setParametersOnAuth=function(e){e.status?setParameterInChromeLocalStorage(chromeLocalStorageConstants.isShortenUrlEnabled,e.is_shorten_url_enabled):setParameterInChromeLocalStorage(chromeLocalStorageConstants.isShortenUrlEnabled,!1)};chrome.tabs.onUpdated.addListener(function(e,o,n){insertAllSitesScript(e),isRecordingInitiated&&insertContentScripts(e),googleAccessTabId&&"complete"==o.status&&void 0!==n.url&&googleAccessTabId==e&&handleUpdateInGoogleAccessTab(n)}),chrome.tabs.onRemoved.addListener(function(e){googleAccessTabId&&e==googleAccessTabId&&(chrome.tabs.update(gmailTabId,{highlighted:!0}),googleAccessTabId=void 0,gmailTabId=void 0,googleAccessResponse.status=!1,messageContentScripts("googleAccessResponse",googleAccessResponse),googleAccessResponse=void 0)}),chrome.windows.onFocusChanged.addListener(function(e){-1!=e&&chrome.tabs.query({windowId:e,active:!0},function(e){for(var o,n=0;n<e.length;n++)o=e[n],injectCsAndAssWhileRecording(o.id,o.url)})}),chrome.tabs.onActivated.addListener(function(e){chrome.tabs.get(e.tabId,function(e){isRecording&&recordingConfiguration.tabRecording&&e.id!=recordingConfiguration.recordingTabId&&(recordingConfiguration.switchTabAlertShown||(showAlertPage(CommonUtils.getError("TAB_CANNOT_BE_RECORDED")),recordingConfiguration.switchTabAlertShown=!0),console.warn("different tab selected while tab recording")),injectCsAndAssWhileRecording(e.id,e.url)})});var blobToDataUrl=function(e,o){var n=new FileReader;n.onload=function(e){o(e.target.result)},n.readAsDataURL(e)},forceStartTimeout,webcamRecorder,webcamUploader,webcamStream,screenStream,recordingOutput,recorder,screenUploader,popupTabId=void 0,autoFinishTimeout,pauseTime;chrome.notifications.onButtonClicked.addListener(function(e,o){console.info("chrome notifications clicked",{notificationId:e,buttonIndex:o}),"abort-continue"==e?0==o?(messageContentScripts("aborted_recording"),recordingConfiguration?setErrorActivityAfterReload(recordingConfiguration.assetId,CommonUtils.getError("USER_ABORT"),function(){chrome.runtime.reload()}):chrome.runtime.reload()):(console.info("user continuing recording"),chrome.notifications.clear(e)):"upgrade-notification"==e&&chrome.tabs.create({url:server+"/video/pricing"})});var audioPlayer,context,mediaStremSource,mediaStremDestination;